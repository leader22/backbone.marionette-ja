<!DOCTYPE html>

<html>
<head>
  <title>backbone.marionette-ja.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>backbone.marionette-ja.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2 id="marionettejs-backbone-marionette-">MarionetteJS (Backbone.Marionette)</h2>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>v1.8.1</p>
<p>Copyright (c)2014 Derick Bailey, Muted Solutions, LLC.
Distributed under MIT license</p>
<p><a href="http://marionettejs.com">http://marionettejs.com</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

<span class="hljs-comment">/*!
 * Includes BabySitter
 * https://github.com/marionettejs/backbone.babysitter/
 *
 * Includes Wreqr
 * https://github.com/marionettejs/backbone.wreqr/
 */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="backbone-babysitter">Backbone.BabySitter</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>v0.1.0</p>
<p>Copyright (c)2014 Derick Bailey, Muted Solutions, LLC.
Distributed under MIT license</p>
<p><a href="http://github.com/marionettejs/backbone.babysitter">http://github.com/marionettejs/backbone.babysitter</a></p>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="backbone-childviewcontainer">Backbone.ChildViewContainer</h2>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>ChildViewContainerは、子となるビューを格納し、
取得、削除する親コンテナを提供します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
Backbone.ChildViewContainer = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Backbone, _)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="-">コンストラクタ</h2>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> Container = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(views)</span>{</span>
    <span class="hljs-keyword">this</span>._views = {};
    <span class="hljs-keyword">this</span>._indexByModel = {};
    <span class="hljs-keyword">this</span>._indexByCustom = {};
    <span class="hljs-keyword">this</span>._updateLength();

    _.each(views, <span class="hljs-keyword">this</span>.add, <span class="hljs-keyword">this</span>);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h2 id="-">メソッド</h2>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  _.extend(Container.prototype, {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>コンテナに対してビューを追加します。
格納されたビューは<code>cid</code>が割り振られ、
モデルのcid(とモデル自身)によって検索できるようになります。
また、<code>cid</code>ではなく独自のキーを割り振ることもできます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    add: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(view, customIndex)</span>{</span>
      <span class="hljs-keyword">var</span> viewCid = view.cid;</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>ビューを格納</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>._views[viewCid] = view;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>モデルのidで索引</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (view.model){
        <span class="hljs-keyword">this</span>._indexByModel[view.model.cid] = viewCid;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>独自のキーで索引</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (customIndex){
        <span class="hljs-keyword">this</span>._indexByCustom[customIndex] = viewCid;
      }

      <span class="hljs-keyword">this</span>._updateLength();
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>紐付けられたモデルでビューを検索し、取得します。
モデルの<code>cid</code>を検索に使用します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    findByModel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(model)</span>{</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.findByModelCid(model.cid);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>紐付けられたモデルの<code>cid</code>でビューを検索し、取得します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    findByModelCid: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(modelCid)</span>{</span>
      <span class="hljs-keyword">var</span> viewCid = <span class="hljs-keyword">this</span>._indexByModel[modelCid];
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.findByCid(viewCid);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>独自のキーでビューを検索し、取得します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    findByCustom: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(index)</span>{</span>
      <span class="hljs-keyword">var</span> viewCid = <span class="hljs-keyword">this</span>._indexByCustom[index];
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.findByCid(viewCid);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>インデックスでビューを検索し、ビューを取得します。
ただしインデックスは保証されていません。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    findByIndex: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(index)</span>{</span>
      <span class="hljs-keyword">return</span> _.values(<span class="hljs-keyword">this</span>._views)[index];
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>直接<code>cid</code>で検索し、ビューを取得します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    findByCid: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cid)</span>{</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._views[cid];
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>ビューを削除します</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    remove: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(view)</span>{</span>
      <span class="hljs-keyword">var</span> viewCid = view.cid;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>モデルの索引を削除</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (view.model){
        <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._indexByModel[view.model.cid];
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>独自キーの索引を削除</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      _.any(<span class="hljs-keyword">this</span>._indexByCustom, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cid, key)</span> {</span>
        <span class="hljs-keyword">if</span> (cid === viewCid) {
          <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._indexByCustom[key];
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
      }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>コンテナに格納したビューを削除</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._views[viewCid];</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>コンテナを更新</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>._updateLength();
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>コンテナに格納されているビューに対してメソッドを実行します。
<code>function.call</code>のように、メソッドと引数を一度に渡すことができます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    call: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(method)</span>{</span>
      <span class="hljs-keyword">this</span>.apply(method, _.tail(<span class="hljs-built_in">arguments</span>));
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>コンテナに格納されているビューに対してメソッドを実行します。
<code>function.apply</code>のように、メソッドと引数を一度に渡すことができます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    apply: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(method, args)</span>{</span>
      _.each(<span class="hljs-keyword">this</span>._views, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(view)</span>{</span>
        <span class="hljs-keyword">if</span> (_.isFunction(view[method])){
          view[method].apply(view, args || []);
        }
      });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>コンテナの<code>.length</code>を更新します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _updateLength: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
      <span class="hljs-keyword">this</span>.length = _.size(<span class="hljs-keyword">this</span>._views);
    }
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Backbone.Collectionからコードを拝借。
<a href="http://backbonejs.org/docs/backbone.html#section-106">http://backbonejs.org/docs/backbone.html#section-106</a></p>
<p>コレクションに関するの操作のために、Underscoreのメソッドを実装します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> methods = [<span class="hljs-string">'forEach'</span>, <span class="hljs-string">'each'</span>, <span class="hljs-string">'map'</span>, <span class="hljs-string">'find'</span>, <span class="hljs-string">'detect'</span>, <span class="hljs-string">'filter'</span>,
    <span class="hljs-string">'select'</span>, <span class="hljs-string">'reject'</span>, <span class="hljs-string">'every'</span>, <span class="hljs-string">'all'</span>, <span class="hljs-string">'some'</span>, <span class="hljs-string">'any'</span>, <span class="hljs-string">'include'</span>,
    <span class="hljs-string">'contains'</span>, <span class="hljs-string">'invoke'</span>, <span class="hljs-string">'toArray'</span>, <span class="hljs-string">'first'</span>, <span class="hljs-string">'initial'</span>, <span class="hljs-string">'rest'</span>,
    <span class="hljs-string">'last'</span>, <span class="hljs-string">'without'</span>, <span class="hljs-string">'isEmpty'</span>, <span class="hljs-string">'pluck'</span>];

  _.each(methods, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(method)</span> {</span>
    Container.prototype[method] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">var</span> views = _.values(<span class="hljs-keyword">this</span>._views);
      <span class="hljs-keyword">var</span> args = [views].concat(_.toArray(<span class="hljs-built_in">arguments</span>));
      <span class="hljs-keyword">return</span> _[method].apply(_, args);
    };
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>コンテナを返す</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> Container;
})(Backbone, _);</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h2 id="backbone-wreqr-backbone-marionette-">Backbone.Wreqr (Backbone.Marionette)</h2>

            </div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>v1.1.0</p>
<p>Copyright (c)2014 Derick Bailey, Muted Solutions, LLC.
Distributed under MIT license</p>
<p><a href="http://github.com/marionettejs/backbone.wreqr">http://github.com/marionettejs/backbone.wreqr</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

Backbone.Wreqr = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Backbone, Marionette, _)</span>{</span>
<span class="hljs-pi">  "use strict"</span>;
  <span class="hljs-keyword">var</span> Wreqr = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <h2 id="-">ハンドラ</h2>

            </div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>メソッドを名前付きで保存しておくところ。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
Wreqr.Handlers = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Backbone, _)</span>{</span>
<span class="hljs-pi">  "use strict"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <h2 id="-">コンストラクタ</h2>

            </div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">var</span> Handlers = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span>{</span>
    <span class="hljs-keyword">this</span>.options = options;
    <span class="hljs-keyword">this</span>._wreqrHandlers = {};

    <span class="hljs-keyword">if</span> (_.isFunction(<span class="hljs-keyword">this</span>.initialize)){
      <span class="hljs-keyword">this</span>.initialize(options);
    }
  };

  Handlers.extend = Backbone.Model.extend;</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <h2 id="-">インスタンスのメンバ</h2>

            </div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
  _.extend(Handlers.prototype, Backbone.Events, {</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>複数のハンドラをオブジェクトリテラルで設定できます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setHandlers: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(handlers)</span>{</span>
      _.each(handlers, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(handler, name)</span>{</span>
        <span class="hljs-keyword">var</span> context = <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">if</span> (_.isObject(handler) &amp;&amp; !_.isFunction(handler)){
          context = handler.context;
          handler = handler.callback;
        }

        <span class="hljs-keyword">this</span>.setHandler(name, handler, context);
      }, <span class="hljs-keyword">this</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>ハンドラを名前付きで設定します。
コンテキストをオプションで指定できます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setHandler: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, handler, context)</span>{</span>
      <span class="hljs-keyword">var</span> config = {
        callback: handler,
        context: context
      };

      <span class="hljs-keyword">this</span>._wreqrHandlers[name] = config;

      <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">"handler:add"</span>, name, handler, context);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>ハンドラが設定されているかを取得します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    hasHandler: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span>{</span>
      <span class="hljs-keyword">return</span> !! <span class="hljs-keyword">this</span>._wreqrHandlers[name];
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>指定した名前のハンドラを取得します。
ハンドラが見つからなかった場合は、例外を投げます。
(とか言いつつreturnしてるだけに見える・・。)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    getHandler: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span>{</span>
      <span class="hljs-keyword">var</span> config = <span class="hljs-keyword">this</span>._wreqrHandlers[name];

      <span class="hljs-keyword">if</span> (!config){
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
        <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.apply(<span class="hljs-built_in">arguments</span>);
        <span class="hljs-keyword">return</span> config.callback.apply(config.context, args);
      };
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>指定した名前のハンドラを削除します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    removeHandler: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span>{</span>
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._wreqrHandlers[name];
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>全てのハンドラを削除します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    removeAllHandlers: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
      <span class="hljs-keyword">this</span>._wreqrHandlers = {};
    }
  });

  <span class="hljs-keyword">return</span> Handlers;
})(Backbone, _);</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <h2 id="wreqr-commandstorage">Wreqr.CommandStorage</h2>

            </div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>コマンドを格納するストレージです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Wreqr.CommandStorage = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
<span class="hljs-pi">  "use strict"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>コンストラクタ</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> CommandStorage = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span>{</span>
    <span class="hljs-keyword">this</span>.options = options;
    <span class="hljs-keyword">this</span>._commands = {};

    <span class="hljs-keyword">if</span> (_.isFunction(<span class="hljs-keyword">this</span>.initialize)){
      <span class="hljs-keyword">this</span>.initialize(options);
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>インスタンスメソッド</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.extend(CommandStorage.prototype, Backbone.Events, {</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>コマンド名を指定して、コマンドのオブジェクトを取得します。
それらは<code>commandName</code>と、<code>instances</code>というプロパティを持ちます。
<code>instances</code>は、実行するコマンド群の配列です。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    getCommands: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(commandName)</span>{</span>
      <span class="hljs-keyword">var</span> commands = <span class="hljs-keyword">this</span>._commands[commandName];</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>見つからなかったら追加</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (!commands){</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>オブジェクト作成</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        commands = {
          command: commandName,
          instances: []
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>そして格納</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>._commands[commandName] = commands;
      }

      <span class="hljs-keyword">return</span> commands;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>名前でコマンドを追加し、引数も格納しておきます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    addCommand: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(commandName, args)</span>{</span>
      <span class="hljs-keyword">var</span> command = <span class="hljs-keyword">this</span>.getCommands(commandName);
      command.instances.push(args);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>コマンド名を指定して、そのコマンドを全て削除します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    clearCommands: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(commandName)</span>{</span>
      <span class="hljs-keyword">var</span> command = <span class="hljs-keyword">this</span>.getCommands(commandName);
      command.instances = [];
    }
  });

  <span class="hljs-keyword">return</span> CommandStorage;
})();</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <h2 id="wreqr-commands">Wreqr.Commands</h2>

            </div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>コマンドのハンドラを登録し実行する、シンプルなコマンドパターンの実装です。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Wreqr.Commands = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Wreqr)</span>{</span>
<span class="hljs-pi">  "use strict"</span>;

  <span class="hljs-keyword">return</span> Wreqr.Handlers.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>デフォルトのストレージタイプ</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    storageType: Wreqr.CommandStorage,

    constructor: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span>{</span>
      <span class="hljs-keyword">this</span>.options = options || {};

      <span class="hljs-keyword">this</span>._initializeStorage(<span class="hljs-keyword">this</span>.options);
      <span class="hljs-keyword">this</span>.on(<span class="hljs-string">"handler:add"</span>, <span class="hljs-keyword">this</span>._executeCommands, <span class="hljs-keyword">this</span>);

      <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
      Wreqr.Handlers.prototype.constructor.apply(<span class="hljs-keyword">this</span>, args);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>与えられた名前と引数でもってコマンドを実行します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    execute: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, args)</span>{</span>
      name = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>];
      args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);

      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.hasHandler(name)){
        <span class="hljs-keyword">this</span>.getHandler(name).apply(<span class="hljs-keyword">this</span>, args);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.storage.addCommand(name, args);
      }

    },</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>格納されたコマンドを実行するための内部メソッドです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _executeCommands: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, handler, context)</span>{</span>
      <span class="hljs-keyword">var</span> command = <span class="hljs-keyword">this</span>.storage.getCommands(name);</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>格納されているコマンドの配列をループし、インスタンス全てを実行します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      _.each(command.instances, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args)</span>{</span>
        handler.apply(context, args);
      });

      <span class="hljs-keyword">this</span>.storage.clearCommands(name);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>コマンドのストレージを初期化する内部メソッドです。
<code>storageType</code>か<code>options.storageType</code>のいずれかを指定します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _initializeStorage: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span>{</span>
      <span class="hljs-keyword">var</span> storage;

      <span class="hljs-keyword">var</span> StorageType = options.storageType || <span class="hljs-keyword">this</span>.storageType;
      <span class="hljs-keyword">if</span> (_.isFunction(StorageType)){
        storage = <span class="hljs-keyword">new</span> StorageType();
      } <span class="hljs-keyword">else</span> {
        storage = StorageType;
      }

      <span class="hljs-keyword">this</span>.storage = storage;
    }
  });

})(Wreqr);</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <h2 id="wreqr-requestresponse">Wreqr.RequestResponse</h2>

            </div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>リクエスト/レスポンスの実装です。
リクエストにハンドラを登録し、レスポンスを返すようにします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Wreqr.RequestResponse = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Wreqr)</span>{</span>
<span class="hljs-pi">  "use strict"</span>;

  <span class="hljs-keyword">return</span> Wreqr.Handlers.extend({
    request: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
      <span class="hljs-keyword">var</span> name = <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.hasHandler(name)) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getHandler(name).apply(<span class="hljs-keyword">this</span>, args);
      }
    }
  });

})(Wreqr);</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <h2 id="event-aggregator">Event Aggregator</h2>

            </div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>各モジュールの関係を疎結合にし、イベントドリブンで構築するための、
Pub/Subの実装を提供するオブジェクトです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
Wreqr.EventAggregator = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Backbone, _)</span>{</span>
<span class="hljs-pi">  "use strict"</span>;
  <span class="hljs-keyword">var</span> EA = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>};</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Backboneの<code>extend</code>機構を使う</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  EA.extend = Backbone.Model.extend;</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Backbone.Eventsも継承</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _.extend(EA.prototype, Backbone.Events);

  <span class="hljs-keyword">return</span> EA;
})(Backbone, _);</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <h2 id="wreqr-channel">Wreqr.Channel</h2>

            </div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>以下のメッセージングの実装をラップするものです。
実装はEventAggregator, RequestResponse, Commandsの3つです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Wreqr.Channel = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Wreqr)</span>{</span>
<span class="hljs-pi">  "use strict"</span>;

  <span class="hljs-keyword">var</span> Channel = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(channelName)</span> {</span>
    <span class="hljs-keyword">this</span>.vent        = <span class="hljs-keyword">new</span> Backbone.Wreqr.EventAggregator();
    <span class="hljs-keyword">this</span>.reqres      = <span class="hljs-keyword">new</span> Backbone.Wreqr.RequestResponse();
    <span class="hljs-keyword">this</span>.commands    = <span class="hljs-keyword">new</span> Backbone.Wreqr.Commands();
    <span class="hljs-keyword">this</span>.channelName = channelName;
  };

  _.extend(Channel.prototype, {</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>このチャンネルのハンドラ類を全て削除します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    reset: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">this</span>.vent.off();
      <span class="hljs-keyword">this</span>.vent.stopListening();
      <span class="hljs-keyword">this</span>.reqres.removeAllHandlers();
      <span class="hljs-keyword">this</span>.commands.removeAllHandlers();
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>それぞれのメッセージングの実装に対して与えられたハッシュを紐付けします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    connectEvents: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(hash, context)</span> {</span>
      <span class="hljs-keyword">this</span>._connect(<span class="hljs-string">'vent'</span>, hash, context);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },

    connectCommands: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(hash, context)</span> {</span>
      <span class="hljs-keyword">this</span>._connect(<span class="hljs-string">'commands'</span>, hash, context);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },

    connectRequests: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(hash, context)</span> {</span>
      <span class="hljs-keyword">this</span>._connect(<span class="hljs-string">'reqres'</span>, hash, context);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>メッセージングの<code>type</code>に応じて、ハンドラを設定します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _connect: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(type, hash, context)</span> {</span>
      <span class="hljs-keyword">if</span> (!hash) {
        <span class="hljs-keyword">return</span>;
      }

      context = context || <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">var</span> method = (type === <span class="hljs-string">'vent'</span>) ? <span class="hljs-string">'on'</span> : <span class="hljs-string">'setHandler'</span>;

      _.each(hash, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fn, eventName)</span> {</span>
        <span class="hljs-keyword">this</span>[type][method](eventName, _.bind(fn, context));
      }, <span class="hljs-keyword">this</span>);
    }
  });


  <span class="hljs-keyword">return</span> Channel;
})(Wreqr);</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <h2 id="wreqr-radio">Wreqr.Radio</h2>

            </div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>複数のチャンネルを操作するオブジェクトを提供します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Wreqr.radio = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Wreqr)</span>{</span>
<span class="hljs-pi">  "use strict"</span>;

  <span class="hljs-keyword">var</span> Radio = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>._channels = {};
    <span class="hljs-keyword">this</span>.vent = {};
    <span class="hljs-keyword">this</span>.commands = {};
    <span class="hljs-keyword">this</span>.reqres = {};
    <span class="hljs-keyword">this</span>._proxyMethods();
  };

  _.extend(Radio.prototype, {

    channel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(channelName)</span> {</span>
      <span class="hljs-keyword">if</span> (!channelName) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Channel must receive a name'</span>);
      }

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._getChannel( channelName );
    },

    _getChannel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(channelName)</span> {</span>
      <span class="hljs-keyword">var</span> channel = <span class="hljs-keyword">this</span>._channels[channelName];

      <span class="hljs-keyword">if</span>(!channel) {
        channel = <span class="hljs-keyword">new</span> Wreqr.Channel(channelName);
        <span class="hljs-keyword">this</span>._channels[channelName] = channel;
      }

      <span class="hljs-keyword">return</span> channel;
    },

    _proxyMethods: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      _.each([<span class="hljs-string">'vent'</span>, <span class="hljs-string">'commands'</span>, <span class="hljs-string">'reqres'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(system)</span> {</span>
        _.each( messageSystems[system], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(method)</span> {</span>
          <span class="hljs-keyword">this</span>[system][method] = proxyMethod(<span class="hljs-keyword">this</span>, system, method);
        }, <span class="hljs-keyword">this</span>);
      }, <span class="hljs-keyword">this</span>);
    }
  });


  <span class="hljs-keyword">var</span> messageSystems = {
    vent: [
      <span class="hljs-string">'on'</span>,
      <span class="hljs-string">'off'</span>,
      <span class="hljs-string">'trigger'</span>,
      <span class="hljs-string">'once'</span>,
      <span class="hljs-string">'stopListening'</span>,
      <span class="hljs-string">'listenTo'</span>,
      <span class="hljs-string">'listenToOnce'</span>
    ],

    commands: [
      <span class="hljs-string">'execute'</span>,
      <span class="hljs-string">'setHandler'</span>,
      <span class="hljs-string">'setHandlers'</span>,
      <span class="hljs-string">'removeHandler'</span>,
      <span class="hljs-string">'removeAllHandlers'</span>
    ],

    reqres: [
      <span class="hljs-string">'request'</span>,
      <span class="hljs-string">'setHandler'</span>,
      <span class="hljs-string">'setHandlers'</span>,
      <span class="hljs-string">'removeHandler'</span>,
      <span class="hljs-string">'removeAllHandlers'</span>
    ]
  };

  <span class="hljs-keyword">var</span> proxyMethod = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(radio, system, method)</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(channelName)</span> {</span>
      <span class="hljs-keyword">var</span> messageSystem = radio._getChannel(channelName)[system];
      <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);

      messageSystem[method].apply(messageSystem, args);
    };
  };

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Radio();

})(Wreqr);


  <span class="hljs-keyword">return</span> Wreqr;
})(Backbone, Backbone.Marionette, _);

<span class="hljs-keyword">var</span> Marionette = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(global, Backbone, _)</span>{</span>
<span class="hljs-pi">  "use strict"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Marionetteとしてエクスポートする名前空間をココで指定</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> Marionette = {};
  Backbone.Marionette = Marionette;</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>あとで使うDOM操作のために<code>$</code>を取得</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Marionette.$ = Backbone.$;</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <h2 id="helpers">Helpers</h2>

            </div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p><code>arguments</code>を<code>slice</code>する用</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> slice = <span class="hljs-built_in">Array</span>.prototype.slice;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">throwError</span><span class="hljs-params">(message, name)</span> {</span>
  <span class="hljs-keyword">var</span> error = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(message);
  error.name = name || <span class="hljs-string">'Error'</span>;
  <span class="hljs-keyword">throw</span> error;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <h2 id="marionette-extend">Marionette.extend</h2>

            </div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Backboneの<code>extend</code>を継承しておく</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Marionette.extend = Backbone.Model.extend;</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <h2 id="marionette-getoption">Marionette.getOption</h2>

            </div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>与えられたターゲットから値を取得します。
<code>options</code>があればそちらを優先して取得します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Marionette.getOption = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(target, optionName)</span>{</span>
  <span class="hljs-keyword">if</span> (!target || !optionName){ <span class="hljs-keyword">return</span>; }
  <span class="hljs-keyword">var</span> value;

  <span class="hljs-keyword">if</span> (target.options &amp;&amp; (optionName <span class="hljs-keyword">in</span> target.options) &amp;&amp; (target.options[optionName] !== <span class="hljs-literal">undefined</span>)){
    value = target.options[optionName];
  } <span class="hljs-keyword">else</span> {
    value = target[optionName];
  }

  <span class="hljs-keyword">return</span> value;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <h2 id="marionette-normalizemethods">Marionette.normalizeMethods</h2>

            </div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>イベント名: メソッド、またはメソッド名のマップを、
イベント名: メソッドの形に揃えて返します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Marionette.normalizeMethods = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(hash)</span> {</span>
  <span class="hljs-keyword">var</span> normalizedHash = {}, method;
  _.each(hash, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fn, name)</span> {</span>
    method = fn;
    <span class="hljs-keyword">if</span> (!_.isFunction(method)) {
      method = <span class="hljs-keyword">this</span>[method];
    }
    <span class="hljs-keyword">if</span> (!method) {
      <span class="hljs-keyword">return</span>;
    }
    normalizedHash[name] = method;
  }, <span class="hljs-keyword">this</span>);
  <span class="hljs-keyword">return</span> normalizedHash;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>トリガーやイベント定義の際、
定義したuiの要素に対して、
<code>@ui.elementName</code>といった記述を可能にします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Marionette.normalizeUIKeys = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(hash, ui)</span> {</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(hash) === <span class="hljs-string">"undefined"</span>) {
    <span class="hljs-keyword">return</span>;
  }

  _.each(_.keys(hash), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v)</span> {</span>
    <span class="hljs-keyword">var</span> pattern = <span class="hljs-regexp">/@ui.[a-zA-Z_$0-9]*/g</span>;
    <span class="hljs-keyword">if</span> (v.match(pattern)) {
      hash[v.replace(pattern, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(r)</span> {</span>
        <span class="hljs-keyword">return</span> ui[r.slice(<span class="hljs-number">4</span>)];
      })] = hash[v];
      <span class="hljs-keyword">delete</span> hash[v];
    }
  });

  <span class="hljs-keyword">return</span> hash;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Backbone.Collectionからコードを拝借。
<a href="http://backbonejs.org/docs/backbone.html#section-106">http://backbonejs.org/docs/backbone.html#section-106</a></p>
<p>コレクションに関するの操作のために、Underscoreのメソッドを実装します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Marionette.actAsCollection = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(object, listProperty)</span> {</span>
  <span class="hljs-keyword">var</span> methods = [<span class="hljs-string">'forEach'</span>, <span class="hljs-string">'each'</span>, <span class="hljs-string">'map'</span>, <span class="hljs-string">'find'</span>, <span class="hljs-string">'detect'</span>, <span class="hljs-string">'filter'</span>,
    <span class="hljs-string">'select'</span>, <span class="hljs-string">'reject'</span>, <span class="hljs-string">'every'</span>, <span class="hljs-string">'all'</span>, <span class="hljs-string">'some'</span>, <span class="hljs-string">'any'</span>, <span class="hljs-string">'include'</span>,
    <span class="hljs-string">'contains'</span>, <span class="hljs-string">'invoke'</span>, <span class="hljs-string">'toArray'</span>, <span class="hljs-string">'first'</span>, <span class="hljs-string">'initial'</span>, <span class="hljs-string">'rest'</span>,
    <span class="hljs-string">'last'</span>, <span class="hljs-string">'without'</span>, <span class="hljs-string">'isEmpty'</span>, <span class="hljs-string">'pluck'</span>];

  _.each(methods, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(method)</span> {</span>
    object[method] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">var</span> list = _.values(_.result(<span class="hljs-keyword">this</span>, listProperty));
      <span class="hljs-keyword">var</span> args = [list].concat(_.toArray(<span class="hljs-built_in">arguments</span>));
      <span class="hljs-keyword">return</span> _[method].apply(_, args);
    };
  });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>イベントを発火、もしくはイベント名に一致するメソッドを実行します。
例えば、
<code>this.triggerMethod(&quot;foo&quot;)</code>は、
“foo”イベントを発火し、”onFoo”に紐付けられたメソッドを実行します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Marionette.triggerMethod = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>イベント名を”:”で分割</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> splitter = <span class="hljs-regexp">/(^|:)(\w)/gi</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>イベント名を受け取り、アッパーケースにします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getEventName</span><span class="hljs-params">(match, prefix, eventName)</span> {</span>
    <span class="hljs-keyword">return</span> eventName.toUpperCase();
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>実装の実態はココに</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> triggerMethod = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>イベント名をメソッド名に</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> methodName = <span class="hljs-string">'on'</span> + event.replace(splitter, getEventName);
    <span class="hljs-keyword">var</span> method = <span class="hljs-keyword">this</span>[methodName];</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>トリガーがメソッドの場合それを実行</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(_.isFunction(<span class="hljs-keyword">this</span>.trigger)) {
      <span class="hljs-keyword">this</span>.trigger.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p><code>onMethodName</code>の形式でメソッドが指定されていれば実行</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (_.isFunction(method)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>イベント名以外を引数として渡す</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> method.apply(<span class="hljs-keyword">this</span>, _.tail(<span class="hljs-built_in">arguments</span>));
    }
  };

  <span class="hljs-keyword">return</span> triggerMethod;
})();</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <h2 id="domrefresh">DOMRefresh</h2>

            </div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>ビューの状態を監視し、DOMに組み込まれたタイミングや、
更新されたタイミングで、”dom:refresh”イベントを発火します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
Marionette.MonitorDOMRefresh = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(documentElement)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>ビューがDOMに組み込まれたかどうかを監視するハンドラ。
Marionette.Regionを使います。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleShow</span><span class="hljs-params">(view)</span>{</span>
    view._isShown = <span class="hljs-literal">true</span>;
    triggerDOMRefresh(view);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>ビューがレンダリングされたかどうかを監視するハンドラ</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleRender</span><span class="hljs-params">(view)</span>{</span>
    view._isRendered = <span class="hljs-literal">true</span>;
    triggerDOMRefresh(view);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>“dom:refresh”イベントを発火し、
“onDomRefresh”に紐付けられたメソッドを実行します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">triggerDOMRefresh</span><span class="hljs-params">(view)</span>{</span>
    <span class="hljs-keyword">if</span> (view._isShown &amp;&amp; view._isRendered &amp;&amp; isInDOM(view)){
      <span class="hljs-keyword">if</span> (_.isFunction(view.triggerMethod)){
        view.triggerMethod(<span class="hljs-string">"dom:refresh"</span>);
      }
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isInDOM</span><span class="hljs-params">(view)</span> {</span>
    <span class="hljs-keyword">return</span> documentElement.contains(view.el);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>エクスポート</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(view)</span>{</span>
    view.listenTo(view, <span class="hljs-string">"show"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
      handleShow(view);
    });

    view.listenTo(view, <span class="hljs-string">"render"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
      handleRender(view);
    });
  };
})(document.documentElement);</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <h2 id="marionette-bindentityevents-unbindentityevents">Marionette.bindEntityEvents &amp; unbindEntityEvents</h2>

            </div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>Backboneの”entity”(コレクションやモデル)に対して、
オブジェクトのメソッドをバインド/アンバインドします。</p>
<p>第一引数は<code>target</code>で、<code>listenTo</code>メソッドが使える必要があります。</p>
<p>第二引数はメソッドをバインドしたいBackboneのモデルかコレクションです。</p>
<p>第三引数は{ “event:name”: “eventHandler” }形式のハッシュです。
メソッド名ではなくメソッドそのものを指定することもできます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Marionette)</span>{</span>
<span class="hljs-pi">  "use strict"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>Bind the event to handlers specified as a string of
handler names on the target object
メソッド名で指定されたイベントを、ハンドラにバインドします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bindFromStrings</span><span class="hljs-params">(target, entity, evt, methods)</span>{</span>
    <span class="hljs-keyword">var</span> methodNames = methods.split(<span class="hljs-regexp">/\s+/</span>);

    _.each(methodNames, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(methodName)</span> {</span>

      <span class="hljs-keyword">var</span> method = target[methodName];
      <span class="hljs-keyword">if</span>(!method) {
        throwError(<span class="hljs-string">"Method '"</span>+ methodName +<span class="hljs-string">"' was configured as an event handler, but does not exist."</span>);
      }

      target.listenTo(entity, evt, method);
    });
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>与えられたメソッドをイベントにバインドする</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bindToFunction</span><span class="hljs-params">(target, entity, evt, method)</span>{</span>
      target.listenTo(entity, evt, method);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>与えられたメソッド名からメソッドを探してきて、イベントをアンバインドする</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unbindFromStrings</span><span class="hljs-params">(target, entity, evt, methods)</span>{</span>
    <span class="hljs-keyword">var</span> methodNames = methods.split(<span class="hljs-regexp">/\s+/</span>);

    _.each(methodNames, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(methodName)</span> {</span>
      <span class="hljs-keyword">var</span> method = target[methodName];
      target.stopListening(entity, evt, method);
    });
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>バインドしたメソッドのアンバインド</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unbindToFunction</span><span class="hljs-params">(target, entity, evt, method)</span>{</span>
      target.stopListening(entity, evt, method);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>ハッシュはもちろん複数くるのでループする</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">iterateEvents</span><span class="hljs-params">(target, entity, bindings, functionCallback, stringCallback)</span>{</span>
    <span class="hljs-keyword">if</span> (!entity || !bindings) { <span class="hljs-keyword">return</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>メソッドそのものがきてもOK</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (_.isFunction(bindings)){
      bindings = bindings.call(target);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>ハッシュをイテレートしてバインドしてく</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(bindings, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(methods, evt)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>メソッド名か、メソッドそのものか判断して処理</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (_.isFunction(methods)){
        functionCallback(target, entity, evt, methods);
      } <span class="hljs-keyword">else</span> {
        stringCallback(target, entity, evt, methods);
      }

    });
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>エクスポート</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Marionette.bindEntityEvents = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(target, entity, bindings)</span>{</span>
    iterateEvents(target, entity, bindings, bindToFunction, bindFromStrings);
  };

  Marionette.unbindEntityEvents = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(target, entity, bindings)</span>{</span>
    iterateEvents(target, entity, bindings, unbindToFunction, unbindFromStrings);
  };

})(Marionette);</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <h2 id="callbacks">Callbacks</h2>

            </div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>複数のコールバックをよしなに処理します。
jQueryの<code>Deferred</code>オブジェクトを使います。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Marionette.Callbacks = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
  <span class="hljs-keyword">this</span>._deferred = Marionette.$.Deferred();
  <span class="hljs-keyword">this</span>._callbacks = [];
};

_.extend(Marionette.Callbacks.prototype, {</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>あとでまとめて実行したいコールバックを追加します。
<code>run</code>メソッドを実行した後でも、ココで追加したコールバックは実行されます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  add: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback, contextOverride)</span>{</span>
    <span class="hljs-keyword">this</span>._callbacks.push({cb: callback, ctx: contextOverride});

    <span class="hljs-keyword">this</span>._deferred.done(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(context, options)</span>{</span>
      <span class="hljs-keyword">if</span> (contextOverride){ context = contextOverride; }
      callback.call(context, options);
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>追加しておいたコールバックを実行します。
コールバックのコンテキストは指定することができます。
この後に追加したコールバックは、即実行されます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  run: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, context)</span>{</span>
    <span class="hljs-keyword">this</span>._deferred.resolve(context, options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>追加したコールバックをリセットします。
これにより同じ内容のコールバックを複数回実行することもできます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reset: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">var</span> callbacks = <span class="hljs-keyword">this</span>._callbacks;
    <span class="hljs-keyword">this</span>._deferred = Marionette.$.Deferred();
    <span class="hljs-keyword">this</span>._callbacks = [];

    _.each(callbacks, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span>{</span>
      <span class="hljs-keyword">this</span>.add(cb.cb, cb.ctx);
    }, <span class="hljs-keyword">this</span>);
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <h2 id="marionette-controller">Marionette Controller</h2>

            </div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>多目的なオブジェクト。
モジュール、ルーターのコントローラーであったり、
他のビュー等を仲介するメディエータとして機能したりします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Marionette.Controller = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span>{</span>
  <span class="hljs-keyword">this</span>.triggerMethod = Marionette.triggerMethod;
  <span class="hljs-keyword">this</span>.options = options || {};

  <span class="hljs-keyword">if</span> (_.isFunction(<span class="hljs-keyword">this</span>.initialize)){
    <span class="hljs-keyword">this</span>.initialize(<span class="hljs-keyword">this</span>.options);
  }
};

Marionette.Controller.extend = Marionette.extend;</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <h2 id="controller-methods">Controller Methods</h2>

            </div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>必ずBackbone.Eventsを使ってイベントをトリガーするように</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>_.extend(Marionette.Controller.prototype, Backbone.Events, {
  close: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">this</span>.stopListening();
    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">this</span>.triggerMethod.apply(<span class="hljs-keyword">this</span>, [<span class="hljs-string">"close"</span>].concat(args));
    <span class="hljs-keyword">this</span>.off();
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <h2 id="region">Region</h2>

            </div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>アプリケーションを構成するリージョンを管理します。
以下、参考リンク。
<a href="http://lostechies.com/derickbailey/2011/12/12/composite-js-apps-regions-and-region-managers/">http://lostechies.com/derickbailey/2011/12/12/composite-js-apps-regions-and-region-managers/</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
Marionette.Region = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span>{</span>
  <span class="hljs-keyword">this</span>.options = options || {};
  <span class="hljs-keyword">this</span>.el = Marionette.getOption(<span class="hljs-keyword">this</span>, <span class="hljs-string">"el"</span>);

  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.el){
    throwError(<span class="hljs-string">"An 'el' must be specified for a region."</span>, <span class="hljs-string">"NoElError"</span>);
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.initialize){
    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.apply(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">this</span>.initialize.apply(<span class="hljs-keyword">this</span>, args);
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <h2 id="region-type-methods">Region Type methods</h2>

            </div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
_.extend(Marionette.Region, {</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>設定オブジェクトを使って、リージョンのインスタンスを作ります。
リージョンのタイプを初期タイプとして設定します。</p>
<p>設定オブジェクトは、jQueryのDOMセレクタ名とリージョンタイプ、
もしくは、以下のようなオブジェクトリテラルで指定します。</p>
<pre><code class="lang-js">{
  selector: <span class="hljs-string">"#foo"</span>,
  regionType: MyCustomRegion
}
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  buildRegion: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(regionConfig, defaultRegionType)</span>{</span>
    <span class="hljs-keyword">var</span> regionIsString = _.isString(regionConfig);
    <span class="hljs-keyword">var</span> regionSelectorIsString = _.isString(regionConfig.selector);
    <span class="hljs-keyword">var</span> regionTypeIsUndefined = _.isUndefined(regionConfig.regionType);
    <span class="hljs-keyword">var</span> regionIsType = _.isFunction(regionConfig);

    <span class="hljs-keyword">if</span> (!regionIsType &amp;&amp; !regionIsString &amp;&amp; !regionSelectorIsString) {
      throwError(<span class="hljs-string">"Region must be specified as a Region type, a selector string or an object with selector property"</span>);
    }

    <span class="hljs-keyword">var</span> selector, RegionType;</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>セレクタを取得</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (regionIsString) {
      selector = regionConfig;
    }

    <span class="hljs-keyword">if</span> (regionConfig.selector) {
      selector = regionConfig.selector;
      <span class="hljs-keyword">delete</span> regionConfig.selector;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>リージョンのタイプを取得</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (regionIsType){
      RegionType = regionConfig;
    }

    <span class="hljs-keyword">if</span> (!regionIsType &amp;&amp; regionTypeIsUndefined) {
      RegionType = defaultRegionType;
    }

    <span class="hljs-keyword">if</span> (regionConfig.regionType) {
      RegionType = regionConfig.regionType;
      <span class="hljs-keyword">delete</span> regionConfig.regionType;
    }

    <span class="hljs-keyword">if</span> (regionIsString || regionIsType) {
      regionConfig = {};
    }

    regionConfig.el = selector;</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>インスタンス作成</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> region = <span class="hljs-keyword">new</span> RegionType(regionConfig);</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>リージョン内でセレクタが要素を見つけられるように、
親要素を持っている場合、<code>getEl</code>メソッドをオーバーライドします。
リージョン作成時に、オブジェクトリテラルで指定された<code>el</code>を、
<code>parentEl.find(selector)</code>で取得しようとしても、
その持点でDOMに組み込まれていないかも知れず、問題になるかもしれません。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (regionConfig.parentEl){
      region.getEl = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(selector)</span> {</span>
        <span class="hljs-keyword">var</span> parentEl = regionConfig.parentEl;
        <span class="hljs-keyword">if</span> (_.isFunction(parentEl)){
          parentEl = parentEl();
        }
        <span class="hljs-keyword">return</span> parentEl.find(selector);
      };
    }

    <span class="hljs-keyword">return</span> region;
  }

});</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <h2 id="region-instance-methods">Region Instance Methods</h2>

            </div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
_.extend(Marionette.Region.prototype, Backbone.Events, {</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>リージョン内のBackboneのビューのインスタンスを表示します。
<code>el</code>に指定した値も参照し、<code>render</code>メソッドを自動的に実行します。
そして、<code>onShow</code>と<code>onClose</code>メソッドををビューに提供します。
ビューを表示した直後、削除される直前に実行されるハンドラです。
<code>preventClose</code>オプションを使えば、新しいビューの表示時に、
自動的に古いビューを削除する挙動を抑制できます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  show: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(view, options)</span>{</span>
    <span class="hljs-keyword">this</span>.ensureEl();

    <span class="hljs-keyword">var</span> showOptions = options || {};
    <span class="hljs-keyword">var</span> isViewClosed = view.isClosed || _.isUndefined(view.$el);
    <span class="hljs-keyword">var</span> isDifferentView = view !== <span class="hljs-keyword">this</span>.currentView;
    <span class="hljs-keyword">var</span> preventClose =  !!showOptions.preventClose;</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p>異なるビューで、preventCloseの指定がない場合に、古いビューを削除</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> _shouldCloseView = !preventClose &amp;&amp; isDifferentView;

    <span class="hljs-keyword">if</span> (_shouldCloseView) {
      <span class="hljs-keyword">this</span>.close();
    }

    view.render();
    Marionette.triggerMethod.call(<span class="hljs-keyword">this</span>, <span class="hljs-string">"before:show"</span>, view);
    Marionette.triggerMethod.call(view, <span class="hljs-string">"before:show"</span>);

    <span class="hljs-keyword">if</span> (isDifferentView || isViewClosed) {
      <span class="hljs-keyword">this</span>.open(view);
    }

    <span class="hljs-keyword">this</span>.currentView = view;

    Marionette.triggerMethod.call(<span class="hljs-keyword">this</span>, <span class="hljs-string">"show"</span>, view);
    Marionette.triggerMethod.call(view, <span class="hljs-string">"show"</span>);
  },

  ensureEl: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.$el || <span class="hljs-keyword">this</span>.$el.length === <span class="hljs-number">0</span>){
      <span class="hljs-keyword">this</span>.$el = <span class="hljs-keyword">this</span>.getEl(<span class="hljs-keyword">this</span>.el);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>リージョンが管理するDOMを検索する挙動を変えるには、
このメソッドをオーバーライドします。
このメソッドは、jQueryオブジェクトを返します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getEl: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(selector)</span>{</span>
    <span class="hljs-keyword">return</span> Marionette.$(selector);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>リージョンが管理するビューを、
どのように<code>$el</code>に追加するかの挙動を変えるには、
このメソッドをオーバーライドします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  open: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(view)</span>{</span>
    <span class="hljs-keyword">this</span>.$el.empty().append(view.el);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>現在表示しているビューを削除します。
何もない場合は、何もせず即座に返ります。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  close: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">var</span> view = <span class="hljs-keyword">this</span>.currentView;
    <span class="hljs-keyword">if</span> (!view || view.isClosed){ <span class="hljs-keyword">return</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p>‘close’か’remove’か、見つかった方を実行</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (view.close) { view.close(); }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (view.remove) { view.remove(); }

    Marionette.triggerMethod.call(<span class="hljs-keyword">this</span>, <span class="hljs-string">"close"</span>, view);

    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.currentView;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p>既存のビューをリージョンにセットします。
この場合、<code>render</code>や<code>onShow</code>は実行されず、
リージョンの<code>el</code>を置き換えることもしません。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  attachView: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(view)</span>{</span>
    <span class="hljs-keyword">this</span>.currentView = view;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>リージョンに属する全てのビューを削除し、キャッシュされた<code>$el</code>を削除します。
次にビューのが表示されるときには、リージョンの<code>el</code>のために再度要素を取得します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  reset: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">this</span>.close();
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.$el;
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>Backboneの<code>extend</code>を継承</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Marionette.Region.extend = Marionette.extend;</pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <h2 id="marionette-regionmanager">Marionette.RegionManager</h2>

            </div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p>1つまたは複数のリージョンを管理します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Marionette.RegionManager = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Marionette)</span>{</span>

  <span class="hljs-keyword">var</span> RegionManager = Marionette.Controller.extend({
    constructor: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span>{</span>
      <span class="hljs-keyword">this</span>._regions = {};
      Marionette.Controller.prototype.constructor.call(<span class="hljs-keyword">this</span>, options);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p>オブジェクトリテラルを使って、複数のリージョンを追加します。
キーがリージョン名、バリューがリージョンの定義であるセレクタです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    addRegions: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(regionDefinitions, defaults)</span>{</span>
      <span class="hljs-keyword">var</span> regions = {};

      _.each(regionDefinitions, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(definition, name)</span>{</span>
        <span class="hljs-keyword">if</span> (_.isString(definition)){
          definition = { selector: definition };
        }

        <span class="hljs-keyword">if</span> (definition.selector){
          definition = _.defaults({}, definition, defaults);
        }

        <span class="hljs-keyword">var</span> region = <span class="hljs-keyword">this</span>.addRegion(name, definition);
        regions[name] = region;
      }, <span class="hljs-keyword">this</span>);

      <span class="hljs-keyword">return</span> regions;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>1つのリージョンを追加し、リージョンのインスタンスを返します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    addRegion: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, definition)</span>{</span>
      <span class="hljs-keyword">var</span> region;

      <span class="hljs-keyword">var</span> isObject = _.isObject(definition);
      <span class="hljs-keyword">var</span> isString = _.isString(definition);
      <span class="hljs-keyword">var</span> hasSelector = !!definition.selector;

      <span class="hljs-keyword">if</span> (isString || (isObject &amp;&amp; hasSelector)){
        region = Marionette.Region.buildRegion(definition, Marionette.Region);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_.isFunction(definition)){
        region = Marionette.Region.buildRegion(definition, Marionette.Region);
      } <span class="hljs-keyword">else</span> {
        region = definition;
      }

      <span class="hljs-keyword">this</span>._store(name, region);
      <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"region:add"</span>, name, region);
      <span class="hljs-keyword">return</span> region;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>リージョン名でリージョンを取得します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span>{</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._regions[name];
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>リージョン名でリージョンを削除します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    removeRegion: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span>{</span>
      <span class="hljs-keyword">var</span> region = <span class="hljs-keyword">this</span>._regions[name];
      <span class="hljs-keyword">this</span>._remove(name, region);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>追加したリージョンを全て削除します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    removeRegions: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
      _.each(<span class="hljs-keyword">this</span>._regions, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(region, name)</span>{</span>
        <span class="hljs-keyword">this</span>._remove(name, region);
      }, <span class="hljs-keyword">this</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>追加したリージョンを全て削除しますが、
引き続き管理下におきます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    closeRegions: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
      _.each(<span class="hljs-keyword">this</span>._regions, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(region, name)</span>{</span>
        region.close();
      }, <span class="hljs-keyword">this</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <p>追加したリージョンを全て削除し、
リージョンマネージャー自身も削除します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    close: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
      <span class="hljs-keyword">this</span>.removeRegions();
      Marionette.Controller.prototype.close.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-151">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              <p>リージョンを追加する内部メソッドです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _store: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, region)</span>{</span>
      <span class="hljs-keyword">this</span>._regions[name] = region;
      <span class="hljs-keyword">this</span>._setLength();
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-152">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              <p>リージョンを削除する内部メソッドです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _remove: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, region)</span>{</span>
      region.close();
      region.stopListening();
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._regions[name];
      <span class="hljs-keyword">this</span>._setLength();
      <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"region:remove"</span>, name, region);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-153">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              <p>管理しているリージョンの数を更新します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _setLength: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
      <span class="hljs-keyword">this</span>.length = _.size(<span class="hljs-keyword">this</span>._regions);
    }

  });

  Marionette.actAsCollection(RegionManager.prototype, <span class="hljs-string">'_regions'</span>);

  <span class="hljs-keyword">return</span> RegionManager;
})(Marionette);</pre></div></div>
            
        </li>
        
        
        <li id="section-154">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              <h2 id="template-cache">Template Cache</h2>

            </div>
            
        </li>
        
        
        <li id="section-155">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-156">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <p><code>&lt;script&gt;</code>タグ内のテンプレートをキャッシュし、
効率よく利用できるように管理します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Marionette.TemplateCache = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(templateId)</span>{</span>
  <span class="hljs-keyword">this</span>.templateId = templateId;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-157">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              <p>TemplateCacheオブジェクトが保持するメソッド。
インスタンスを作る代わりに、
このオブジェクトでテンプレートのキャッシュを管理します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>_.extend(Marionette.TemplateCache, {
  templateCaches: {},</pre></div></div>
            
        </li>
        
        
        <li id="section-158">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              <p>idによって特定のテンプレートを取得します。
キャッシュがあるかをまず確認し、なければDOMから取得します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(templateId)</span>{</span>
    <span class="hljs-keyword">var</span> cachedTemplate = <span class="hljs-keyword">this</span>.templateCaches[templateId];

    <span class="hljs-keyword">if</span> (!cachedTemplate){
      cachedTemplate = <span class="hljs-keyword">new</span> Marionette.TemplateCache(templateId);
      <span class="hljs-keyword">this</span>.templateCaches[templateId] = cachedTemplate;
    }

    <span class="hljs-keyword">return</span> cachedTemplate.load();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-159">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <p>テンプレートのキャッシュをクリアします。
引数なしに実行されると全てのテンプレートを、
idを与えるとそれらのキャッシュをクリアします。
<code>clear()</code>もしくは、<code>clear(&quot;#t1&quot;, &quot;#t2&quot;, &quot;...&quot;)</code>のように使います。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  clear: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">var</span> i;
    <span class="hljs-keyword">var</span> args = slice.call(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">var</span> length = args.length;

    <span class="hljs-keyword">if</span> (length &gt; <span class="hljs-number">0</span>){
      <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;length; i++){
        <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.templateCaches[args[i]];
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.templateCaches = {};
    }
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-160">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              <p>TemplateCacheのインスタンスメソッドです。
これらにより、自身の状態やロード済みかどうかを知ることができます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>_.extend(Marionette.TemplateCache.prototype, {</pre></div></div>
            
        </li>
        
        
        <li id="section-161">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p>テンプレートをロードする内部メソッド</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  load: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-162">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <p>多重に読み込まれるのを防止</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.compiledTemplate){
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.compiledTemplate;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-163">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              <p>テンプレートをロードしてコンパイル</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> template = <span class="hljs-keyword">this</span>.loadTemplate(<span class="hljs-keyword">this</span>.templateId);
    <span class="hljs-keyword">this</span>.compiledTemplate = <span class="hljs-keyword">this</span>.compileTemplate(template);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.compiledTemplate;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-164">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              <p>デフォルトではDOMからテンプレートをロードします。
テンプレート取得の挙動を変える場合は、このメソッドをオーバーライドします。
AMD/RequireJSの非同期読み込みや、以下のようなプラグインを使う場合です。
<a href="https://github.com/marionettejs/backbone.marionette/wiki/Using-marionette-with-requirejs">https://github.com/marionettejs/backbone.marionette/wiki/Using-marionette-with-requirejs</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  loadTemplate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(templateId)</span>{</span>
    <span class="hljs-keyword">var</span> template = Marionette.$(templateId).html();

    <span class="hljs-keyword">if</span> (!template || template.length === <span class="hljs-number">0</span>){
      throwError(<span class="hljs-string">"Could not find template: '"</span> + templateId + <span class="hljs-string">"'"</span>, <span class="hljs-string">"NoTemplateError"</span>);
    }

    <span class="hljs-keyword">return</span> template;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-165">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-165">&#182;</a>
              </div>
              <p>キャッシュする前に、テンプレートをコンパイルします。
Handlebars等のテンプレートエンジンを使いたい場合や、
プリコンパイルの必要がない場合には、このメソッドをオーバーライドします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  compileTemplate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(rawTemplate)</span>{</span>
    <span class="hljs-keyword">return</span> _.template(rawTemplate);
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-166">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-166">&#182;</a>
              </div>
              <h2 id="renderer">Renderer</h2>

            </div>
            
        </li>
        
        
        <li id="section-167">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-168">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-168">&#182;</a>
              </div>
              <p>与えられたデータとテンプレートを使ってレンダリングします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Marionette.Renderer = {</pre></div></div>
            
        </li>
        
        
        <li id="section-169">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-169">&#182;</a>
              </div>
              <p>データを使ってテンプレートをレンダリングします。
<code>template</code>の引数は、<code>TemplateCache</code>オブジェクトへ渡ります。
レンダリングとテンプレートの管理を独自にやる場合は、このメソッドをオーバーライドします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  render: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(template, data)</span>{</span>

    <span class="hljs-keyword">if</span> (!template) {
      throwError(<span class="hljs-string">"Cannot render the template since it's false, null or undefined."</span>, <span class="hljs-string">"TemplateNotFoundError"</span>);
    }

    <span class="hljs-keyword">var</span> templateFunc;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> template === <span class="hljs-string">"function"</span>){
      templateFunc = template;
    } <span class="hljs-keyword">else</span> {
      templateFunc = Marionette.TemplateCache.get(template);
    }

    <span class="hljs-keyword">return</span> templateFunc(data);
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-170">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-170">&#182;</a>
              </div>
              <h2 id="marionette-view">Marionette.View</h2>

            </div>
            
        </li>
        
        
        <li id="section-171">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-171">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-172">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-172">&#182;</a>
              </div>
              <p>Marionetteビューの元となるビュータイプを定義します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Marionette.View = Backbone.View.extend({

  constructor: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span>{</span>
    _.bindAll(<span class="hljs-keyword">this</span>, <span class="hljs-string">"render"</span>);

    <span class="hljs-keyword">if</span> (_.isObject(<span class="hljs-keyword">this</span>.behaviors)) {
      <span class="hljs-keyword">new</span> Marionette.Behaviors(<span class="hljs-keyword">this</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-173">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-173">&#182;</a>
              </div>
              <p>ビューの初期化時に渡されるオプションです。
コレはBackboneで<code>this.options</code>が使われなくなったため、
後方互換のために実装されています。
よって、いくつかの場面では使われないかもしれません。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.options = _.extend({}, _.result(<span class="hljs-keyword">this</span>, <span class="hljs-string">'options'</span>), _.isFunction(options) ? options.call(<span class="hljs-keyword">this</span>) : options);</pre></div></div>
            
        </li>
        
        
        <li id="section-174">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-174">&#182;</a>
              </div>
              <p>@ui記法をパース</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.events = <span class="hljs-keyword">this</span>.normalizeUIKeys(_.result(<span class="hljs-keyword">this</span>, <span class="hljs-string">'events'</span>));
    Backbone.View.prototype.constructor.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);

    Marionette.MonitorDOMRefresh(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.listenTo(<span class="hljs-keyword">this</span>, <span class="hljs-string">"show"</span>, <span class="hljs-keyword">this</span>.onShowCalled);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-175">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-175">&#182;</a>
              </div>
              <p>メソッドが存在し、一致するイベントがあった場合に実行するため、
“triggerMthod”をインポートします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  triggerMethod: Marionette.triggerMethod,</pre></div></div>
            
        </li>
        
        
        <li id="section-176">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-176">&#182;</a>
              </div>
              <p>イベント名: メソッド、またはメソッド名のマップを、
イベント名: メソッドの形に揃えて返す”normalizeMethods”をインポートします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  normalizeMethods: Marionette.normalizeMethods,</pre></div></div>
            
        </li>
        
        
        <li id="section-177">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-177">&#182;</a>
              </div>
              <p>このビューのインスタンス用のテンプレートを取得します。
ビューの定義時に<code>template</code>プロパティで設定することもできますし、
コンストラクタへオプションとして<code>template: &quot;whatever&quot;</code>形式で渡すこともできます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getTemplate: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">return</span> Marionette.getOption(<span class="hljs-keyword">this</span>, <span class="hljs-string">"template"</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-178">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-178">&#182;</a>
              </div>
              <p>テンプレートのヘルパーメソッドをミックスインします。
オブジェクトリテラルか、オブジェクトを返すメソッドで、
<code>templateHelpers</code>プロパティに設定します。
設定されたものは全てコピーして渡されます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  mixinTemplateHelpers: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(target)</span>{</span>
    target = target || {};
    <span class="hljs-keyword">var</span> templateHelpers = Marionette.getOption(<span class="hljs-keyword">this</span>, <span class="hljs-string">"templateHelpers"</span>);
    <span class="hljs-keyword">if</span> (_.isFunction(templateHelpers)){
      templateHelpers = templateHelpers.call(<span class="hljs-keyword">this</span>);
    }
    <span class="hljs-keyword">return</span> _.extend(target, templateHelpers);
  },

  normalizeUIKeys: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(hash)</span> {</span>
    <span class="hljs-keyword">var</span> ui = _.result(<span class="hljs-keyword">this</span>, <span class="hljs-string">'ui'</span>);
    <span class="hljs-keyword">return</span> Marionette.normalizeUIKeys(hash, ui);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-179">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-179">&#182;</a>
              </div>
              <p>トリガーの定義をDOMイベントからビューのイベントへコンバートします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  configureTriggers: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.triggers) { <span class="hljs-keyword">return</span>; }

    <span class="hljs-keyword">var</span> triggerEvents = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-180">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-180">&#182;</a>
              </div>
              <p><code>triggers</code>はメソッドでもOK</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> triggers = <span class="hljs-keyword">this</span>.normalizeUIKeys(_.result(<span class="hljs-keyword">this</span>, <span class="hljs-string">"triggers"</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-181">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-181">&#182;</a>
              </div>
              <p>preventDefaultやstopPropagationをトリガーにも設定します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(triggers, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, key)</span>{</span>

      <span class="hljs-keyword">var</span> hasOptions = _.isObject(value);
      <span class="hljs-keyword">var</span> eventName = hasOptions ? value.event : value;</pre></div></div>
            
        </li>
        
        
        <li id="section-182">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-182">&#182;</a>
              </div>
              <p>DOMイベント用にハンドラを作成</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      triggerEvents[key] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-183">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-183">&#182;</a>
              </div>
              <p>イベントを抑止</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (e) {
          <span class="hljs-keyword">var</span> prevent = e.preventDefault;
          <span class="hljs-keyword">var</span> stop = e.stopPropagation;

          <span class="hljs-keyword">var</span> shouldPrevent = hasOptions ? value.preventDefault : prevent;
          <span class="hljs-keyword">var</span> shouldStop = hasOptions ? value.stopPropagation : stop;

          <span class="hljs-keyword">if</span> (shouldPrevent &amp;&amp; prevent) { prevent.apply(e); }
          <span class="hljs-keyword">if</span> (shouldStop &amp;&amp; stop) { stop.apply(e); }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-184">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-184">&#182;</a>
              </div>
              <p>イベント用に引数を作成</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> args = {
          view: <span class="hljs-keyword">this</span>,
          model: <span class="hljs-keyword">this</span>.model,
          collection: <span class="hljs-keyword">this</span>.collection
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-185">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-185">&#182;</a>
              </div>
              <p>イベント発火</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.triggerMethod(eventName, args);
      };

    }, <span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">return</span> triggerEvents;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-186">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-186">&#182;</a>
              </div>
              <p><code>triggers</code>、<code>modelEvents</code>、<code>collectionEvents</code>にハンドラをバインドする、
Backbone.ViewのdelegateEventsをオーバーライドします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  delegateEvents: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(events)</span>{</span>
    <span class="hljs-keyword">this</span>._delegateDOMEvents(events);
    Marionette.bindEntityEvents(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.model, Marionette.getOption(<span class="hljs-keyword">this</span>, <span class="hljs-string">"modelEvents"</span>));
    Marionette.bindEntityEvents(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.collection, Marionette.getOption(<span class="hljs-keyword">this</span>, <span class="hljs-string">"collectionEvents"</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-187">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-187">&#182;</a>
              </div>
              <p>DOMイベントやトリガーを扱う内部メソッドです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _delegateDOMEvents: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(events)</span>{</span>
    events = events || <span class="hljs-keyword">this</span>.events;
    <span class="hljs-keyword">if</span> (_.isFunction(events)){ events = events.call(<span class="hljs-keyword">this</span>); }

    <span class="hljs-keyword">var</span> combinedEvents = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-188">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-188">&#182;</a>
              </div>
              <p>このビューがビヘイビアのイベントを持っているか確認</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> behaviorEvents = _.result(<span class="hljs-keyword">this</span>, <span class="hljs-string">'behaviorEvents'</span>) || {};
    <span class="hljs-keyword">var</span> triggers = <span class="hljs-keyword">this</span>.configureTriggers();</pre></div></div>
            
        </li>
        
        
        <li id="section-189">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-189">&#182;</a>
              </div>
              <p>ビヘイビアのイベントは、ビューのイベントとトリガーによってオーバーライドされます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.extend(combinedEvents, behaviorEvents, events, triggers);

    Backbone.View.prototype.delegateEvents.call(<span class="hljs-keyword">this</span>, combinedEvents);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-190">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-190">&#182;</a>
              </div>
              <p><code>triggers</code>、<code>modelEvents</code>、<code>collectionEvents</code>へのハンドラをアンバインドする、
Backbone.ViewのundelegateEventsをオーバーライドします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  undelegateEvents: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
    Backbone.View.prototype.undelegateEvents.apply(<span class="hljs-keyword">this</span>, args);

    Marionette.unbindEntityEvents(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.model, Marionette.getOption(<span class="hljs-keyword">this</span>, <span class="hljs-string">"modelEvents"</span>));
    Marionette.unbindEntityEvents(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.collection, Marionette.getOption(<span class="hljs-keyword">this</span>, <span class="hljs-string">"collectionEvents"</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-191">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-191">&#182;</a>
              </div>
              <p><code>show</code>イベントを扱う内部メソッド。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  onShowCalled: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>},</pre></div></div>
            
        </li>
        
        
        <li id="section-192">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-192">&#182;</a>
              </div>
              <p>ビューをDOMから削除し、イベントをアンバインドする<code>close</code>メソッドの実装です。
リージョンはこのメソッドを実行します。
<code>onClose</code>メソッドを定義することができ、それはビューが削除された直後に実行されます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  close: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isClosed) { <span class="hljs-keyword">return</span>; }

    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-193">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-193">&#182;</a>
              </div>
              <p><code>onBeforeClose</code>メソッドが<code>false</code>を返すことで、closeをキャンセルできます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> shouldClose = <span class="hljs-keyword">this</span>.triggerMethod.apply(<span class="hljs-keyword">this</span>, [<span class="hljs-string">"before:close"</span>].concat(args));
    <span class="hljs-keyword">if</span> (shouldClose === <span class="hljs-literal">false</span>){
      <span class="hljs-keyword">return</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-194">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-194">&#182;</a>
              </div>
              <p>実際のcloseが行われるより先に、フラグをタテておきます。
そうすることで、他のビューに関連した”close”イベントが無限ループすることを防ぎます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.isClosed = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.triggerMethod.apply(<span class="hljs-keyword">this</span>, [<span class="hljs-string">"close"</span>].concat(args));</pre></div></div>
            
        </li>
        
        
        <li id="section-195">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-195">&#182;</a>
              </div>
              <p>UIに紐付けられたハンドラをアンバインド</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.unbindUIElements();</pre></div></div>
            
        </li>
        
        
        <li id="section-196">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-196">&#182;</a>
              </div>
              <p>DOMからビューを削除</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.remove();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-197">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-197">&#182;</a>
              </div>
              <p>ビューの”ui”プロパティ(中身はjQueryのセレクタ)を使い、実際にDOMをバインドします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  bindUIElements: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.ui) { <span class="hljs-keyword">return</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-198">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-198">&#182;</a>
              </div>
              <p>UIの定義を_uiBindingsへ退避。
そうすることで後にリセットすることができ、
レンダリングされたビューからバインドする要素を見つけることができます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._uiBindings){
      <span class="hljs-keyword">this</span>._uiBindings = <span class="hljs-keyword">this</span>.ui;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-199">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-199">&#182;</a>
              </div>
              <p>メソッドなら結果、そうでないなら値をバインディング</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> bindings = _.result(<span class="hljs-keyword">this</span>, <span class="hljs-string">"_uiBindings"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-200">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-200">&#182;</a>
              </div>
              <p>最初は何もないように</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.ui = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-201">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-201">&#182;</a>
              </div>
              <p>それぞれのセレクタをバインド</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(_.keys(bindings), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> {</span>
      <span class="hljs-keyword">var</span> selector = bindings[key];
      <span class="hljs-keyword">this</span>.ui[key] = <span class="hljs-keyword">this</span>.$(selector);
    }, <span class="hljs-keyword">this</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-202">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-202">&#182;</a>
              </div>
              <p>“ui”プロパティに定義された要素をアンバインドします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  unbindUIElements: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.ui || !<span class="hljs-keyword">this</span>._uiBindings){ <span class="hljs-keyword">return</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-203">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-203">&#182;</a>
              </div>
              <p>全てのバインディングを削除</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(<span class="hljs-keyword">this</span>.ui, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">($el, name)</span>{</span>
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.ui[name];
    }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-204">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-204">&#182;</a>
              </div>
              <p>UIの定義を元通りにリセット</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.ui = <span class="hljs-keyword">this</span>._uiBindings;
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._uiBindings;
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-205">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-205">&#182;</a>
              </div>
              <h2 id="item-view">Item View</h2>

            </div>
            
        </li>
        
        
        <li id="section-206">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-206">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-207">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-207">&#182;</a>
              </div>
              <p>単一のアイテムを表示するビューの実装です。
underscore.jsのテンプレートを使ってレンダリングするメソッドや、
紐付けられたビューのモデルかコレクションのデータをシリアライズするメソッドのほか、
<code>onRender</code>のように、ビューで拡張されたメソッドを実行することができます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Marionette.ItemView = Marionette.View.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-208">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-208">&#182;</a>
              </div>
              <p>オーバーライド可能なMarionette.View.prototype.constructorを変更できるようにします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    Marionette.View.prototype.constructor.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-209">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-209">&#182;</a>
              </div>
              <p>紐付けられたモデル、コレクションをビュー用にシリアライズします。
モデルが見つかった場合は<code>.toJSON()</code>を実行した結果を返し、
コレクションがみつかった場合は、<code>items</code>という名前の配列で<code>.toJSON()</code>の結果を返します。
このメソッドをオーバーライドすることで、独自の<code>serializeData</code>を実装することもできます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  serializeData: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">var</span> data = {};

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.model) {
      data = <span class="hljs-keyword">this</span>.model.toJSON();
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.collection) {
      data = { items: <span class="hljs-keyword">this</span>.collection.toJSON() };
    }

    <span class="hljs-keyword">return</span> data;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-210">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-210">&#182;</a>
              </div>
              <p>ビューをレンダリングします。
デフォルトでは、underscore.jsのテンプレートを使います。
このメソッドをオーバーライドすることもできますが、
<code>Marionette.Renderer</code>オブジェクトをオーバーライドするほうが良いです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  render: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">this</span>.isClosed = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"before:render"</span>, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"item:before:render"</span>, <span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">var</span> data = <span class="hljs-keyword">this</span>.serializeData();
    data = <span class="hljs-keyword">this</span>.mixinTemplateHelpers(data);

    <span class="hljs-keyword">var</span> template = <span class="hljs-keyword">this</span>.getTemplate();
    <span class="hljs-keyword">var</span> html = Marionette.Renderer.render(template, data);

    <span class="hljs-keyword">this</span>.$el.html(html);
    <span class="hljs-keyword">this</span>.bindUIElements();

    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"render"</span>, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"item:rendered"</span>, <span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-211">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-211">&#182;</a>
              </div>
              <p>close時のイベントをもう少し定義したい場合は、
このメソッドをオーバーライドします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  close: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isClosed){ <span class="hljs-keyword">return</span>; }

    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">'item:before:close'</span>);

    Marionette.View.prototype.close.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);

    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">'item:closed'</span>);
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-212">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-212">&#182;</a>
              </div>
              <h2 id="collection-view">Collection View</h2>

            </div>
            
        </li>
        
        
        <li id="section-213">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-213">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-214">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-214">&#182;</a>
              </div>
              <p>Backbone.Collectionをイテレートし、
それぞれのモデルでItemViewをレンダリングします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Marionette.CollectionView = Marionette.View.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-215">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-215">&#182;</a>
              </div>
              <p>ItemViewで使うイベント名のプレフィックス</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  itemViewEventPrefix: <span class="hljs-string">"itemview"</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-216">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-216">&#182;</a>
              </div>
              <p>コンストラクタ</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span>{</span>
    <span class="hljs-keyword">this</span>._initChildViewStorage();

    Marionette.View.prototype.constructor.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);

    <span class="hljs-keyword">this</span>._initialEvents();
    <span class="hljs-keyword">this</span>.initRenderBuffer();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-217">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-217">&#182;</a>
              </div>
              <p>パフォーマンスのため、各要素を随時DOMに組み込むのではなく、
documentFragmentを使います。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  initRenderBuffer: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.elBuffer = document.createDocumentFragment();
    <span class="hljs-keyword">this</span>._bufferedChildren = [];
  },

  startBuffering: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.initRenderBuffer();
    <span class="hljs-keyword">this</span>.isBuffering = <span class="hljs-literal">true</span>;
  },

  endBuffering: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.isBuffering = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.appendBuffer(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.elBuffer);
    <span class="hljs-keyword">this</span>._triggerShowBufferedChildren();
    <span class="hljs-keyword">this</span>.initRenderBuffer();
  },

  _triggerShowBufferedChildren: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._isShown) {
      _.each(<span class="hljs-keyword">this</span>._bufferedChildren, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(child)</span> {</span>
        Marionette.triggerMethod.call(child, <span class="hljs-string">"show"</span>);
      });
      <span class="hljs-keyword">this</span>._bufferedChildren = [];
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-218">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-218">&#182;</a>
              </div>
              <p>コレクションビューへのイベントをバインドします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _initialEvents: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.collection){
      <span class="hljs-keyword">this</span>.listenTo(<span class="hljs-keyword">this</span>.collection, <span class="hljs-string">"add"</span>, <span class="hljs-keyword">this</span>.addChildView);
      <span class="hljs-keyword">this</span>.listenTo(<span class="hljs-keyword">this</span>.collection, <span class="hljs-string">"remove"</span>, <span class="hljs-keyword">this</span>.removeItemView);
      <span class="hljs-keyword">this</span>.listenTo(<span class="hljs-keyword">this</span>.collection, <span class="hljs-string">"reset"</span>, <span class="hljs-keyword">this</span>.render);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-219">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-219">&#182;</a>
              </div>
              <p>コレクションに子となるビューを追加します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addChildView: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item, collection, options)</span>{</span>
    <span class="hljs-keyword">this</span>.closeEmptyView();
    <span class="hljs-keyword">var</span> ItemView = <span class="hljs-keyword">this</span>.getItemView(item);
    <span class="hljs-keyword">var</span> index = <span class="hljs-keyword">this</span>.collection.indexOf(item);
    <span class="hljs-keyword">this</span>.addItemView(item, ItemView, index);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-220">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-220">&#182;</a>
              </div>
              <p>子ビューの<code>onShow</code>が呼ばれるように、<code>Marionette.View</code>からオーバーライドします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  onShowCalled: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">this</span>.children.each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(child)</span>{</span>
      Marionette.triggerMethod.call(child, <span class="hljs-string">"show"</span>);
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-221">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-221">&#182;</a>
              </div>
              <p>レンダリング直前のイベントとコールバックを実行する内部メソッドです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  triggerBeforeRender: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"before:render"</span>, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"collection:before:render"</span>, <span class="hljs-keyword">this</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-222">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-222">&#182;</a>
              </div>
              <p>レンダリング直後のイベントとコールバックを実行する内部メソッドです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  triggerRendered: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"render"</span>, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"collection:rendered"</span>, <span class="hljs-keyword">this</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-223">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-223">&#182;</a>
              </div>
              <p>コレクションをレンダリングします。
オーバーライドすることで独自の方法でレンダリングすることもできます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  render: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">this</span>.isClosed = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.triggerBeforeRender();
    <span class="hljs-keyword">this</span>._renderChildren();
    <span class="hljs-keyword">this</span>.triggerRendered();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-224">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-224">&#182;</a>
              </div>
              <p>内部メソッドです。
レンダリング実行の際に、CompositeViewがよりイベント駆動しやすいよう、
分けて実装しておきます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _renderChildren: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">this</span>.startBuffering();

    <span class="hljs-keyword">this</span>.closeEmptyView();
    <span class="hljs-keyword">this</span>.closeChildren();

    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isEmpty(<span class="hljs-keyword">this</span>.collection)) {
      <span class="hljs-keyword">this</span>.showCollection();
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.showEmptyView();
    }

    <span class="hljs-keyword">this</span>.endBuffering();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-225">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-225">&#182;</a>
              </div>
              <p>コレクション内のそれぞれのアイテムをループし、表示する内部メソッドです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  showCollection: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">var</span> ItemView;
    <span class="hljs-keyword">this</span>.collection.each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item, index)</span>{</span>
      ItemView = <span class="hljs-keyword">this</span>.getItemView(item);
      <span class="hljs-keyword">this</span>.addItemView(item, ItemView, index);
    }, <span class="hljs-keyword">this</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-226">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-226">&#182;</a>
              </div>
              <p>コレクションが空の時に入れておく空のビューを作る内部メソッドです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  showEmptyView: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">var</span> EmptyView = <span class="hljs-keyword">this</span>.getEmptyView();

    <span class="hljs-keyword">if</span> (EmptyView &amp;&amp; !<span class="hljs-keyword">this</span>._showingEmptyView){
      <span class="hljs-keyword">this</span>._showingEmptyView = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">var</span> model = <span class="hljs-keyword">new</span> Backbone.Model();
      <span class="hljs-keyword">this</span>.addItemView(model, EmptyView, <span class="hljs-number">0</span>);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-227">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-227">&#182;</a>
              </div>
              <p>空のビューのインスタンスがあれば、それを削除する内部メソッドです。
空のコレクションビューに対して、何かアイテムが追加された時に実行されます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  closeEmptyView: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._showingEmptyView){
      <span class="hljs-keyword">this</span>.closeChildren();
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._showingEmptyView;
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-228">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-228">&#182;</a>
              </div>
              <p>空のビューのビュータイプを取得します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getEmptyView: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">return</span> Marionette.getOption(<span class="hljs-keyword">this</span>, <span class="hljs-string">"emptyView"</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-229">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-229">&#182;</a>
              </div>
              <p>アイテムビューのタイプを取得します。
<code>this.options.itemView</code>か、<code>itemView</code>の定義から取得します。
“options”が優先して使われます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getItemView: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span>{</span>
    <span class="hljs-keyword">var</span> itemView = Marionette.getOption(<span class="hljs-keyword">this</span>, <span class="hljs-string">"itemView"</span>);

    <span class="hljs-keyword">if</span> (!itemView){
      throwError(<span class="hljs-string">"An `itemView` must be specified"</span>, <span class="hljs-string">"NoItemViewError"</span>);
    }

    <span class="hljs-keyword">return</span> itemView;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-230">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-230">&#182;</a>
              </div>
              <p>アイテムビューを追加し、コレクションのビューとしてレンダリングします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addItemView: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item, ItemView, index)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-231">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-231">&#182;</a>
              </div>
              <p>定義されていれば、オプションを取得</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> itemViewOptions = Marionette.getOption(<span class="hljs-keyword">this</span>, <span class="hljs-string">"itemViewOptions"</span>);
    <span class="hljs-keyword">if</span> (_.isFunction(itemViewOptions)){
      itemViewOptions = itemViewOptions.call(<span class="hljs-keyword">this</span>, item, index);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-232">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-232">&#182;</a>
              </div>
              <p>子ビューを作成</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> view = <span class="hljs-keyword">this</span>.buildItemView(item, ItemView, itemViewOptions);</pre></div></div>
            
        </li>
        
        
        <li id="section-233">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-233">&#182;</a>
              </div>
              <p>子ビューのイベントを転送しておく</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.addChildViewEventForwarding(view);</pre></div></div>
            
        </li>
        
        
        <li id="section-234">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-234">&#182;</a>
              </div>
              <p>ビューの追加予告</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"before:item:added"</span>, view);</pre></div></div>
            
        </li>
        
        
        <li id="section-235">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-235">&#182;</a>
              </div>
              <p>子ビューを格納することで、適切に削除できるようにします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.children.add(view);</pre></div></div>
            
        </li>
        
        
        <li id="section-236">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-236">&#182;</a>
              </div>
              <p>レンダリングし、表示</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.renderItemView(view, index);</pre></div></div>
            
        </li>
        
        
        <li id="section-237">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-237">&#182;</a>
              </div>
              <p>既に表示されていれば、”show”mメソッドを実行</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._isShown &amp;&amp; !<span class="hljs-keyword">this</span>.isBuffering){
      Marionette.triggerMethod.call(view, <span class="hljs-string">"show"</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-238">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-238">&#182;</a>
              </div>
              <p>ビューが追加された</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"after:item:added"</span>, view);

    <span class="hljs-keyword">return</span> view;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-239">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-239">&#182;</a>
              </div>
              <p>子ビューのイベントを引き継ぎます。
それらのイベント名には、”itemview:”という接頭辞がつきます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addChildViewEventForwarding: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(view)</span>{</span>
    <span class="hljs-keyword">var</span> prefix = Marionette.getOption(<span class="hljs-keyword">this</span>, <span class="hljs-string">"itemViewEventPrefix"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-240">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-240">&#182;</a>
              </div>
              <p>アイテムビューに紐づくイベントを親に転送します。
イベント名の先頭に、”itemview:”を付加します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.listenTo(view, <span class="hljs-string">"all"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
      <span class="hljs-keyword">var</span> args = slice.call(<span class="hljs-built_in">arguments</span>);
      <span class="hljs-keyword">var</span> rootEvent = args[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">var</span> itemEvents = <span class="hljs-keyword">this</span>.normalizeMethods(<span class="hljs-keyword">this</span>.getItemEvents());

      args[<span class="hljs-number">0</span>] = prefix + <span class="hljs-string">":"</span> + rootEvent;
      args.splice(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, view);</pre></div></div>
            
        </li>
        
        
        <li id="section-241">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-241">&#182;</a>
              </div>
              <p>itemEventが定義されていれば実行します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> itemEvents !== <span class="hljs-string">"undefined"</span> &amp;&amp; _.isFunction(itemEvents[rootEvent])) {
        itemEvents[rootEvent].apply(<span class="hljs-keyword">this</span>, args);
      }

      Marionette.triggerMethod.apply(<span class="hljs-keyword">this</span>, args);
    }, <span class="hljs-keyword">this</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-242">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-242">&#182;</a>
              </div>
              <p>itemEventsを取得します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getItemEvents: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span> (_.isFunction(<span class="hljs-keyword">this</span>.itemEvents)) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.itemEvents.call(<span class="hljs-keyword">this</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.itemEvents;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-243">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-243">&#182;</a>
              </div>
              <p>アイテムビューをレンダリングします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  renderItemView: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(view, index)</span> {</span>
    view.render();
    <span class="hljs-keyword">this</span>.appendHtml(<span class="hljs-keyword">this</span>, view, index);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-244">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-244">&#182;</a>
              </div>
              <p>コレクションの内の各モデルに対し、<code>itemView</code>を作成します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  buildItemView: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item, ItemViewType, itemViewOptions)</span>{</span>
    <span class="hljs-keyword">var</span> options = _.extend({model: item}, itemViewOptions);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ItemViewType(options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-245">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-245">&#182;</a>
              </div>
              <p>アイテムからビューを取得し、削除します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  removeItemView: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span>{</span>
    <span class="hljs-keyword">var</span> view = <span class="hljs-keyword">this</span>.children.findByModel(item);
    <span class="hljs-keyword">this</span>.removeChildView(view);
    <span class="hljs-keyword">this</span>.checkEmpty();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-246">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-246">&#182;</a>
              </div>
              <p>子ビューを削除します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  removeChildView: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(view)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-247">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-247">&#182;</a>
              </div>
              <p>適切に子ビューを削除します。
貼られていたハンドラも同じく削除します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (view){</pre></div></div>
            
        </li>
        
        
        <li id="section-248">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-248">&#182;</a>
              </div>
              <p><code>close</code>か<code>remove</code>か、見つかったほうを実行</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (view.close) { view.close(); }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (view.remove) { view.remove(); }

      <span class="hljs-keyword">this</span>.stopListening(view);
      <span class="hljs-keyword">this</span>.children.remove(view);
    }

    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"item:removed"</span>, view);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-249">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-249">&#182;</a>
              </div>
              <p>コレクションが空かどうかをチェックするヘルパーです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  isEmpty: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collection)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-250">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-250">&#182;</a>
              </div>
              <p>空かどうか判定</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> !<span class="hljs-keyword">this</span>.collection || <span class="hljs-keyword">this</span>.collection.length === <span class="hljs-number">0</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-251">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-251">&#182;</a>
              </div>
              <p>もし空の場合、空のビューを表示します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  checkEmpty: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isEmpty(<span class="hljs-keyword">this</span>.collection)){
      <span class="hljs-keyword">this</span>.showEmptyView();
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-252">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-252">&#182;</a>
              </div>
              <p><code>appendHtml</code>をオーバーライドする際は、一緒にオーバーライドします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  appendBuffer: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collectionView, buffer)</span> {</span>
    collectionView.$el.append(buffer);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-253">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-253">&#182;</a>
              </div>
              <p>コレクションの<code>el</code>にDOMを組み込みます。
単純に<code>.append</code>以外のことをする場合は、このメソッドをオーバーライドします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  appendHtml: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(collectionView, itemView, index)</span>{</span>
    <span class="hljs-keyword">if</span> (collectionView.isBuffering) {</pre></div></div>
            
        </li>
        
        
        <li id="section-254">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-254">&#182;</a>
              </div>
              <p>DOMの更新はコストが高いので、初回のレンダリング時や、
resetイベントの時にはバッファを使うようにします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      collectionView.elBuffer.appendChild(itemView.el);
      collectionView._bufferedChildren.push(itemView);
    }
    <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-255">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-255">&#182;</a>
              </div>
              <p>既にレンダリングされていたり、新しいアイテムを追加するときは、
直接DOMに要素を追加します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      collectionView.$el.append(itemView.el);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-256">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-256">&#182;</a>
              </div>
              <p>全ての子ビューを貯めておく<code>children</code>オブジェクトを作成する内部メソッドです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _initChildViewStorage: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">this</span>.children = <span class="hljs-keyword">new</span> Backbone.ChildViewContainer();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-257">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-257">&#182;</a>
              </div>
              <p>コレクションのビューを適切にcloseするためのハンドラです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  close: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isClosed){ <span class="hljs-keyword">return</span>; }

    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"collection:before:close"</span>);
    <span class="hljs-keyword">this</span>.closeChildren();
    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"collection:closed"</span>);

    Marionette.View.prototype.close.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-258">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-258">&#182;</a>
              </div>
              <p>コレクションのもつ子ビューを削除します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  closeChildren: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">this</span>.children.each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(child)</span>{</span>
      <span class="hljs-keyword">this</span>.removeChildView(child);
    }, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.checkEmpty();
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-259">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-259">&#182;</a>
              </div>
              <h2 id="composite-view">Composite View</h2>

            </div>
            
        </li>
        
        
        <li id="section-260">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-260">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-261">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-261">&#182;</a>
              </div>
              <p>単純な親子でなく、枝葉のような階層構造を実現するときに使います。
コレクションビューを元に実装されていて、
<code>modelView</code>としてアイテムをトップレベルにレンダリングします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Marionette.CompositeView = Marionette.CollectionView.extend({</pre></div></div>
            
        </li>
        
        
        <li id="section-262">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-262">&#182;</a>
              </div>
              <p>オーバーライド可能なMarionette.CollectionView.prototype.constructorを変更できるようにします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    Marionette.CollectionView.prototype.constructor.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-263">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-263">&#182;</a>
              </div>
              <p>コンポジットビューにバインドする初期イベントを定義します。
オーバーライドすることで、独自のイベントをバインドすることもできます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _initialEvents: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-264">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-264">&#182;</a>
              </div>
              <p>コンポジットビューがレンダリングされた後でのみイベントをバインドします。
その持点で存在しないitemViewContainerにビューを追加しないようにするためです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.once(<span class="hljs-string">'render'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.collection){
        <span class="hljs-keyword">this</span>.listenTo(<span class="hljs-keyword">this</span>.collection, <span class="hljs-string">"add"</span>, <span class="hljs-keyword">this</span>.addChildView);
        <span class="hljs-keyword">this</span>.listenTo(<span class="hljs-keyword">this</span>.collection, <span class="hljs-string">"remove"</span>, <span class="hljs-keyword">this</span>.removeItemView);
        <span class="hljs-keyword">this</span>.listenTo(<span class="hljs-keyword">this</span>.collection, <span class="hljs-string">"reset"</span>, <span class="hljs-keyword">this</span>._renderChildren);
      }
    });

  },</pre></div></div>
            
        </li>
        
        
        <li id="section-265">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-265">&#182;</a>
              </div>
              <p>コレクション内のアイテムをレンダリングする際に、<code>itemView</code>を取得します。
<code>itemView</code>が定義されていなかった場合、
デフォルトでは、<code>this.itemView</code>か<code>Marionette.CompositeView</code>を返します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getItemView: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span>{</span>
    <span class="hljs-keyword">var</span> itemView = Marionette.getOption(<span class="hljs-keyword">this</span>, <span class="hljs-string">"itemView"</span>) || <span class="hljs-keyword">this</span>.constructor;

    <span class="hljs-keyword">if</span> (!itemView){
      throwError(<span class="hljs-string">"An `itemView` must be specified"</span>, <span class="hljs-string">"NoItemViewError"</span>);
    }

    <span class="hljs-keyword">return</span> itemView;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-266">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-266">&#182;</a>
              </div>
              <p>コレクションをビュー用にシリアライズします。
このメソッドをオーバーライドすることで、独自の<code>serializeData</code>を実装することもできます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  serializeData: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">var</span> data = {};

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.model){
      data = <span class="hljs-keyword">this</span>.model.toJSON();
    }

    <span class="hljs-keyword">return</span> data;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-267">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-267">&#182;</a>
              </div>
              <p>モデルとコレクションを1度だけ使いレンダリングします。
再度実行された場合は、モデルのビューのみ再レンダリングしますが、
コレクションに対しては行いません。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  render: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">this</span>.isRendered = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.isClosed = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.resetItemViewContainer();

    <span class="hljs-keyword">this</span>.triggerBeforeRender();
    <span class="hljs-keyword">var</span> html = <span class="hljs-keyword">this</span>.renderModel();
    <span class="hljs-keyword">this</span>.$el.html(html);</pre></div></div>
            
        </li>
        
        
        <li id="section-268">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-268">&#182;</a>
              </div>
              <p>UIのバインディングはココ行います。
さもないと、コレクションが全てレンダリングされるまで利用できないからです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.bindUIElements();
    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"composite:model:rendered"</span>);

    <span class="hljs-keyword">this</span>._renderChildren();

    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"composite:rendered"</span>);
    <span class="hljs-keyword">this</span>.triggerRendered();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },

  _renderChildren: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isRendered){
      <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"composite:collection:before:render"</span>);
      Marionette.CollectionView.prototype._renderChildren.call(<span class="hljs-keyword">this</span>);
      <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"composite:collection:rendered"</span>);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-269">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-269">&#182;</a>
              </div>
              <p>コンポジットビューのいち部分として、各モデルをレンダリングします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  renderModel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">var</span> data = {};
    data = <span class="hljs-keyword">this</span>.serializeData();
    data = <span class="hljs-keyword">this</span>.mixinTemplateHelpers(data);

    <span class="hljs-keyword">var</span> template = <span class="hljs-keyword">this</span>.getTemplate();
    <span class="hljs-keyword">return</span> Marionette.Renderer.render(template, data);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-270">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-270">&#182;</a>
              </div>
              <p><code>appendHtml</code>をオーバーライドする際は、一緒にオーバーライドします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  appendBuffer: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(compositeView, buffer)</span> {</span>
    <span class="hljs-keyword">var</span> $container = <span class="hljs-keyword">this</span>.getItemViewContainer(compositeView);
    $container.append(buffer);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-271">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-271">&#182;</a>
              </div>
              <p><code>itemViewContainer</code>に対して、itemViewのインスタンスの<code>el</code>を追加します。
子となるアイテム達をDOMに組み込む挙動を変えたい場合は、
このメソッドをオーバーライドします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  appendHtml: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(compositeView, itemView, index)</span>{</span>
    <span class="hljs-keyword">if</span> (compositeView.isBuffering) {
      compositeView.elBuffer.appendChild(itemView.el);
      compositeView._bufferedChildren.push(itemView);
    }
    <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-272">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-272">&#182;</a>
              </div>
              <p>コレクションのレンダリングを終えていた場合は、
直接要素をDOMに組み込みます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> $container = <span class="hljs-keyword">this</span>.getItemViewContainer(compositeView);
      $container.append(itemView.el);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-273">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-273">&#182;</a>
              </div>
              <p><code>appendHtml</code>の前に、<code>$itemViewContainer</code>の存在を保証する内部メソッドです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getItemViewContainer: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(containerView)</span>{</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-string">"$itemViewContainer"</span> <span class="hljs-keyword">in</span> containerView){
      <span class="hljs-keyword">return</span> containerView.$itemViewContainer;
    }

    <span class="hljs-keyword">var</span> container;
    <span class="hljs-keyword">var</span> itemViewContainer = Marionette.getOption(containerView, <span class="hljs-string">"itemViewContainer"</span>);
    <span class="hljs-keyword">if</span> (itemViewContainer){

      <span class="hljs-keyword">var</span> selector = _.isFunction(itemViewContainer) ? itemViewContainer.call(containerView) : itemViewContainer;

      <span class="hljs-keyword">if</span> (selector.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">"@"</span> &amp;&amp; containerView.ui) {
        container = containerView.ui[selector.substr(<span class="hljs-number">4</span>)];
      } <span class="hljs-keyword">else</span> {
        container = containerView.$(selector);
      }

      <span class="hljs-keyword">if</span> (container.length &lt;= <span class="hljs-number">0</span>) {
        throwError(<span class="hljs-string">"The specified `itemViewContainer` was not found: "</span> + containerView.itemViewContainer, <span class="hljs-string">"ItemViewContainerMissingError"</span>);
      }

    } <span class="hljs-keyword">else</span> {
      container = containerView.$el;
    }

    containerView.$itemViewContainer = container;
    <span class="hljs-keyword">return</span> container;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-274">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-274">&#182;</a>
              </div>
              <p>レンダリング時、<code>$itemViewContainer</code>をリセットする内部メソッドです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  resetItemViewContainer: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.$itemViewContainer){
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.$itemViewContainer;
    }
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-275">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-275">&#182;</a>
              </div>
              <h2 id="layout">Layout</h2>

            </div>
            
        </li>
        
        
        <li id="section-276">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-276">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-277">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-277">&#182;</a>
              </div>
              <p>レイアウトは、
アプリケーションやサブアプリケーションを含む複数のリージョンや、
ネストしたレイアウト等を管理するものです。</p>
<p>特別なビュータイプを持ち、HTMLを用意して自身のリージョンとし、
そこにリージョンのインスタンスを紐付けていきます。
コンポジットビューやサブアプリケーションのために使われます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Marionette.Layout = Marionette.ItemView.extend({
  regionType: Marionette.Region,</pre></div></div>
            
        </li>
        
        
        <li id="section-278">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-278">&#182;</a>
              </div>
              <p><code>initialize</code>時にリージョンが利用できることを保証します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
    options = options || {};

    <span class="hljs-keyword">this</span>._firstRender = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>._initializeRegions(options);

    Marionette.ItemView.prototype.constructor.call(<span class="hljs-keyword">this</span>, options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-279">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-279">&#182;</a>
              </div>
              <p>初回のレイアウトのレンダリング時は、既存のリージョンを使います。
その後のレンダリング時には、ビューを一度closeし、
新しくレンダリングするDOMのために<code>el</code>をリセットします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  render: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isClosed){</pre></div></div>
            
        </li>
        
        
        <li id="section-280">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-280">&#182;</a>
              </div>
              <p>一度レイアウトが閉じられたということは、
再度リージョンを初期化する必要があることを意味します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>._initializeRegions();
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._firstRender) {</pre></div></div>
            
        </li>
        
        
        <li id="section-281">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-281">&#182;</a>
              </div>
              <p>初回のレンダリングではリージョンをリセットしない</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>._firstRender = <span class="hljs-literal">false</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isClosed){</pre></div></div>
            
        </li>
        
        
        <li id="section-282">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-282">&#182;</a>
              </div>
              <p>初回のレンダリングでない場合、各リージョンの<code>el</code>を再度初期化</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>._reInitializeRegions();
    }

    <span class="hljs-keyword">return</span> Marionette.ItemView.prototype.render.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-283">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-283">&#182;</a>
              </div>
              <p>リージョンを閉じるハンドラで、ビュー自身を削除します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  close: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isClosed){ <span class="hljs-keyword">return</span>; }
    <span class="hljs-keyword">this</span>.regionManager.close();
    Marionette.ItemView.prototype.close.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-284">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-284">&#182;</a>
              </div>
              <p>名前を指定し、単一のリージョンをレイアウトに追加します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addRegion: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, definition)</span>{</span>
    <span class="hljs-keyword">var</span> regions = {};
    regions[name] = definition;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._buildRegions(regions)[name];
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-285">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-285">&#182;</a>
              </div>
              <p>複数のリージョンを、以下のようなオブジェクトリテラルで追加します。
<code>{name: definition, name2: def2}</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addRegions: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(regions)</span>{</span>
    <span class="hljs-keyword">this</span>.regions = _.extend({}, <span class="hljs-keyword">this</span>.regions, regions);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._buildRegions(regions);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-286">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-286">&#182;</a>
              </div>
              <p>名前を指定し、単一のリージョンをレイアウトから削除します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  removeRegion: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name)</span>{</span>
    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.regions[name];
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.regionManager.removeRegion(name);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-287">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-287">&#182;</a>
              </div>
              <p>リージョンへアクセスする方法の一つです。
<code>getRegion(&#39;main&#39;)</code>のように使います。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getRegion: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(region)</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.regionManager.get(region);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-288">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-288">&#182;</a>
              </div>
              <p>リージョンを作成する内部メソッドです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _buildRegions: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(regions)</span>{</span>
    <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">var</span> defaults = {
      regionType: Marionette.getOption(<span class="hljs-keyword">this</span>, <span class="hljs-string">"regionType"</span>),
      parentEl: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span> <span class="hljs-keyword">return</span> that.$el; }
    };

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.regionManager.addRegions(regions, defaults);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-289">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-289">&#182;</a>
              </div>
              <p>このレイアウトの<code>regions</code>プロパティの内容に従い、
リージョンを初期化していく内部メソッドです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _initializeRegions: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
    <span class="hljs-keyword">var</span> regions;
    <span class="hljs-keyword">this</span>._initRegionManager();

    <span class="hljs-keyword">if</span> (_.isFunction(<span class="hljs-keyword">this</span>.regions)) {
      regions = <span class="hljs-keyword">this</span>.regions(options);
    } <span class="hljs-keyword">else</span> {
      regions = <span class="hljs-keyword">this</span>.regions || {};
    }

    <span class="hljs-keyword">this</span>.addRegions(regions);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-290">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-290">&#182;</a>
              </div>
              <p>それぞれのリージョンが持つ<code>el</code>を全て初期化しなおす内部メソッドです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _reInitializeRegions: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">this</span>.regionManager.closeRegions();
    <span class="hljs-keyword">this</span>.regionManager.each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(region)</span>{</span>
      region.reset();
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-291">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-291">&#182;</a>
              </div>
              <p>リージョンマネージャーと、属する全てのリージョンを初期化する内部メソッドです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _initRegionManager: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">this</span>.regionManager = <span class="hljs-keyword">new</span> Marionette.RegionManager();

    <span class="hljs-keyword">this</span>.listenTo(<span class="hljs-keyword">this</span>.regionManager, <span class="hljs-string">"region:add"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, region)</span>{</span>
      <span class="hljs-keyword">this</span>[name] = region;
      <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">"region:add"</span>, name, region);
    });

    <span class="hljs-keyword">this</span>.listenTo(<span class="hljs-keyword">this</span>.regionManager, <span class="hljs-string">"region:remove"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, region)</span>{</span>
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>[name];
      <span class="hljs-keyword">this</span>.trigger(<span class="hljs-string">"region:remove"</span>, name, region);
    });
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-292">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-292">&#182;</a>
              </div>
              <h2 id="behavior">Behavior</h2>

            </div>
            
        </li>
        
        
        <li id="section-293">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-293">&#182;</a>
              </div>
              <p>ビヘイビアはどんなビューにもミックスインできる独立したDOM/UIのインターフェースです。
これを使うことでブラックボックス化しやすい処理を切り出すことができ、
ビューのコードをシンプルに保つことができます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Marionette.Behavior = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_, Backbone)</span>{</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Behavior</span><span class="hljs-params">(options, view)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-294">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-294">&#182;</a>
              </div>
              <p>ビューへの参照を持ちます。
それによって、ビューと直接やりとりしやすくなります。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.view = view;
    <span class="hljs-keyword">this</span>.defaults = _.result(<span class="hljs-keyword">this</span>, <span class="hljs-string">"defaults"</span>) || {};
    <span class="hljs-keyword">this</span>.options  = _.extend({}, <span class="hljs-keyword">this</span>.defaults, options);</pre></div></div>
            
        </li>
        
        
        <li id="section-295">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-295">&#182;</a>
              </div>
              <p>ビューへの$メソッドです。
ビヘイビアのスコープ内でDOMを取得するのに便利です。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.$ = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.view.$.apply(<span class="hljs-keyword">this</span>.view, <span class="hljs-built_in">arguments</span>);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-296">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-296">&#182;</a>
              </div>
              <p>コンストラクタへ渡されたオプションで初期化します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.initialize.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
  }

  _.extend(Behavior.prototype, Backbone.Events, {
    initialize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>},</pre></div></div>
            
        </li>
        
        
        <li id="section-297">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-297">&#182;</a>
              </div>
              <p>ビヘイビアのクラスへのtriggerMethodです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    triggerMethod: Marionette.triggerMethod
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-298">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-298">&#182;</a>
              </div>
              <p>Borrow Backbones extend implementation
this allows us to setup a proper
inheritence pattern that follow in suite
with the rest of Marionette views.
Marionetteのビューがビヘイビアを継承できるよう、
Backboneの<code>extend</code>を継承</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Behavior.extend = Marionette.extend;

  <span class="hljs-keyword">return</span> Behavior;
})(_, Backbone);</pre></div></div>
            
        </li>
        
        
        <li id="section-299">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-299">&#182;</a>
              </div>
              <h2 id="marionette-behaviors">Marionette.Behaviors</h2>

            </div>
            
        </li>
        
        
        <li id="section-300">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-300">&#182;</a>
              </div>
              <p>ビヘイビアズはビヘイビアのインスタンスとビューの仲介をします。
ビヘイビアズを使うには、必ず<code>behaviorsLookup</code>メソッドを実装する必要があります。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
Marionette.Behaviors = (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(Marionette, _)</span> {</span>

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Behaviors</span><span class="hljs-params">(view)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-301">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-301">&#182;</a>
              </div>
              <p>ビューで定義されるビヘイビアは、必ずオブジェクトか、
オブジェクトを返すメソッドである必要があります。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.behaviors = Behaviors.parseBehaviors(view, _.result(view, <span class="hljs-string">'behaviors'</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-302">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-302">&#182;</a>
              </div>
              <p>ビューのメソッドのいくつかをラップします。
ビヘイビア側でそれぞれを先に呼び、その後ビュー側のメソッドを実行します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Behaviors.wrap(view, <span class="hljs-keyword">this</span>.behaviors, [
      <span class="hljs-string">'bindUIElements'</span>, <span class="hljs-string">'unbindUIElements'</span>,
      <span class="hljs-string">'delegateEvents'</span>, <span class="hljs-string">'undelegateEvents'</span>,
      <span class="hljs-string">'onShow'</span>, <span class="hljs-string">'onClose'</span>,
      <span class="hljs-string">'behaviorEvents'</span>, <span class="hljs-string">'triggerMethod'</span>,
      <span class="hljs-string">'setElement'</span>
    ]);
  }

  <span class="hljs-keyword">var</span> methods = {
    setElement: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(setElement, behaviors)</span> {</span>
      setElement.apply(<span class="hljs-keyword">this</span>, _.tail(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">2</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-303">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-303">&#182;</a>
              </div>
              <p>ビューの<code>$el</code>を一旦ビヘイビアに保持します。
ビューの<code>$el</code>は、<code>setElement</code>の実行が終わるまでセットされないためです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      _.each(behaviors, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(b)</span> {</span>
        b.$el = <span class="hljs-keyword">this</span>.$el;
      }, <span class="hljs-keyword">this</span>);
    },

    onShow: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(onShow, behaviors)</span> {</span>
      <span class="hljs-keyword">var</span> args = _.tail(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">2</span>);

      _.each(behaviors, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(b)</span> {</span>
        Marionette.triggerMethod.apply(b, [<span class="hljs-string">"show"</span>].concat(args));
      });

      <span class="hljs-keyword">if</span> (_.isFunction(onShow)) {
        onShow.apply(<span class="hljs-keyword">this</span>, args);
      }
    },

    onClose: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(onClose, behaviors)</span>{</span>
      <span class="hljs-keyword">var</span> args = _.tail(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">2</span>);

      _.each(behaviors, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(b)</span> {</span>
        Marionette.triggerMethod.apply(b, [<span class="hljs-string">"close"</span>].concat(args));
      });

      <span class="hljs-keyword">if</span> (_.isFunction(onClose)) {
        onClose.apply(<span class="hljs-keyword">this</span>, args);
      }
    },

    bindUIElements: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(bindUIElements, behaviors)</span> {</span>
      bindUIElements.apply(<span class="hljs-keyword">this</span>);
      _.invoke(behaviors, bindUIElements);
    },

    unbindUIElements: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(unbindUIElements, behaviors)</span> {</span>
      unbindUIElements.apply(<span class="hljs-keyword">this</span>);
      _.invoke(behaviors, unbindUIElements);
    },

    triggerMethod: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(triggerMethod, behaviors)</span> {</span>
      <span class="hljs-keyword">var</span> args = _.tail(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">2</span>);
      triggerMethod.apply(<span class="hljs-keyword">this</span>, args);

      _.each(behaviors, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(b)</span> {</span>
        triggerMethod.apply(b, args);
      });
    },

    delegateEvents: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(delegateEvents, behaviors)</span> {</span>
      <span class="hljs-keyword">var</span> args = _.tail(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">2</span>);
      delegateEvents.apply(<span class="hljs-keyword">this</span>, args);

      _.each(behaviors, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(b)</span>{</span>
        Marionette.bindEntityEvents(b, <span class="hljs-keyword">this</span>.model, Marionette.getOption(b, <span class="hljs-string">"modelEvents"</span>));
        Marionette.bindEntityEvents(b, <span class="hljs-keyword">this</span>.collection, Marionette.getOption(b, <span class="hljs-string">"collectionEvents"</span>));
      }, <span class="hljs-keyword">this</span>);
    },

    undelegateEvents: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(undelegateEvents, behaviors)</span> {</span>
      <span class="hljs-keyword">var</span> args = _.tail(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">2</span>);
      undelegateEvents.apply(<span class="hljs-keyword">this</span>, args);

      _.each(behaviors, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(b)</span> {</span>
        Marionette.unbindEntityEvents(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.model, Marionette.getOption(b, <span class="hljs-string">"modelEvents"</span>));
        Marionette.unbindEntityEvents(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.collection, Marionette.getOption(b, <span class="hljs-string">"collectionEvents"</span>));
      }, <span class="hljs-keyword">this</span>);
    },

    behaviorEvents: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(behaviorEvents, behaviors)</span> {</span>
      <span class="hljs-keyword">var</span> _behaviorsEvents = {};
      <span class="hljs-keyword">var</span> viewUI = _.result(<span class="hljs-keyword">this</span>, <span class="hljs-string">'ui'</span>);

      _.each(behaviors, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(b, i)</span> {</span>
        <span class="hljs-keyword">var</span> _events = {};
        <span class="hljs-keyword">var</span> behaviorEvents = _.result(b, <span class="hljs-string">'events'</span>) || {};
        <span class="hljs-keyword">var</span> behaviorUI = _.result(b, <span class="hljs-string">'ui'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-304">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-304">&#182;</a>
              </div>
              <p>内部用にUIオブジェクトを保持します。
最初にビューのもの、そしてビヘイビアのものを使います。
こうすることで、親ビューにおいてもビヘイビアをUIオブジェクトに適用できます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> ui = _.extend({}, viewUI, behaviorUI);</pre></div></div>
            
        </li>
        
        
        <li id="section-305">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-305">&#182;</a>
              </div>
              <p>ビヘイビアのイベント定義において、
<code>@ui.elementName</code>といった記述を可能にします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        behaviorEvents = Marionette.normalizeUIKeys(behaviorEvents, ui);

        _.each(_.keys(behaviorEvents), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-306">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-306">&#182;</a>
              </div>
              <p>キー名が衝突しないように、半角スペースをキー名の最後に付加します。
これは、Backboneのイベント定義において、”click .foo”と”click .foo “が同義であることに依存しています。
最初のビヘイビアが1つ分のスペースを使っているので、ココでは2つ分のスペースを付加します。</p>

            </div>
            
        </li>
        
        
        <li id="section-307">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-307">&#182;</a>
              </div>
              <p>長さ0 or 1の配列では””となるので、” “にするために+2します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> whitespace = (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(i+<span class="hljs-number">2</span>)).join(<span class="hljs-string">" "</span>);
          <span class="hljs-keyword">var</span> eventKey   = key + whitespace;
          <span class="hljs-keyword">var</span> handler    = _.isFunction(behaviorEvents[key]) ? behaviorEvents[key] : b[behaviorEvents[key]];

          _events[eventKey] = _.bind(handler, b);
        });

        _behaviorsEvents = _.extend(_behaviorsEvents, _events);
      });

      <span class="hljs-keyword">return</span> _behaviorsEvents;
    }
  };

  _.extend(Behaviors, {</pre></div></div>
            
        </li>
        
        
        <li id="section-308">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-308">&#182;</a>
              </div>
              <p>ビヘイビアを保持するオブジェクトを取得するメソッドです。
ユーザーによって実装されるのを期待するプレースホルダーです。
以下は例です。
Marionette.Behaviors.behaviorsLookup: function() {
  return App.Behaviors
}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    behaviorsLookup: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"You must define where your behaviors are stored. See https://github.com/marionettejs/backbone.marionette/blob/master/docs/marionette.behaviors.md#behaviorslookup"</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-309">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-309">&#182;</a>
              </div>
              <p>ビヘイビアを取得します。
<code>options.behaviorClass</code>が指定してあればソレを、
そうでなければ<code>behaviorsLookup</code>で取得したものを使います。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    getBehaviorClass: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, key)</span> {</span>
      <span class="hljs-keyword">if</span> (options.behaviorClass) {
        <span class="hljs-keyword">return</span> options.behaviorClass;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-310">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-310">&#182;</a>
              </div>
              <p>単一階層のオブジェクトもしくはメソッドである必要があります。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> _.isFunction(Behaviors.behaviorsLookup) ? Behaviors.behaviorsLookup.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>)[key] : Behaviors.behaviorsLookup[key];
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-311">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-311">&#182;</a>
              </div>
              <p>ビューのビヘイビアをマップします。
それぞれのビヘイビアをインスタンス化し、オプションとビューをを渡していきます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    parseBehaviors: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(view, behaviors)</span>{</span>
      <span class="hljs-keyword">return</span> _.map(behaviors, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, key)</span>{</span>
        <span class="hljs-keyword">var</span> BehaviorClass = Behaviors.getBehaviorClass(options, key);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BehaviorClass(options, view);
      });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-312">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-312">&#182;</a>
              </div>
              <p>ビューの内部メソッドをラップすることで、ビヘイビアの処理を委譲します。
例えば、onCloseはビヘイビア全てでcloseを実行し、ビュー自身のcloseを実行します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    wrap: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(view, behaviors, methodNames)</span> {</span>
      _.each(methodNames, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(methodName)</span> {</span>
        view[methodName] = _.partial(methods[methodName], view[methodName], behaviors);
      });
    }
  });

  <span class="hljs-keyword">return</span> Behaviors;

})(Marionette, _);</pre></div></div>
            
        </li>
        
        
        <li id="section-313">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-313">&#182;</a>
              </div>
              <h2 id="approuter">AppRouter</h2>

            </div>
            
        </li>
        
        
        <li id="section-314">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-314">&#182;</a>
              </div>
              <p>ルートをハンドリングして、異なるオブジェクトのとあるメソッドを実行する・・、
そのようなコードを減らすのがAppRouterです。
<code>appRoutes</code>で、指定したオブジェクトのメソッドを直接指定できるようになっています。</p>
<p>コレは、<code>controller</code>というオブジェクトのみを引数に取るようになっています。
1つの巨大なルーターとコントローラーが出来上がるより、
適切な単位で分割することを推奨しているからです。</p>
<p>もちろん、いわゆるルーターとしての使い方も可能です。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
Marionette.AppRouter = Backbone.Router.extend({

  constructor: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span>{</span>
    Backbone.Router.prototype.constructor.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);

    <span class="hljs-keyword">this</span>.options = options || {};

    <span class="hljs-keyword">var</span> appRoutes = Marionette.getOption(<span class="hljs-keyword">this</span>, <span class="hljs-string">"appRoutes"</span>);
    <span class="hljs-keyword">var</span> controller = <span class="hljs-keyword">this</span>._getController();
    <span class="hljs-keyword">this</span>.processAppRoutes(controller, appRoutes);
    <span class="hljs-keyword">this</span>.on(<span class="hljs-string">"route"</span>, <span class="hljs-keyword">this</span>._processOnRoute, <span class="hljs-keyword">this</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-315">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-315">&#182;</a>
              </div>
              <p>Backbone.Routerの<code>route</code>に似ていますが、
こちらは指定したコントローラーのメソッドを実行します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  appRoute: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(route, methodName)</span> {</span>
    <span class="hljs-keyword">var</span> controller = <span class="hljs-keyword">this</span>._getController();
    <span class="hljs-keyword">this</span>._addAppRoute(controller, route, methodName);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-316">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-316">&#182;</a>
              </div>
              <p>該当するイベントをトリガーし、onRouteを発火します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _processOnRoute: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(routeName, routeArgs)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-317">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-317">&#182;</a>
              </div>
              <p>一致するパスを探す</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> routePath = _.invert(<span class="hljs-keyword">this</span>.appRoutes)[routeName];</pre></div></div>
            
        </li>
        
        
        <li id="section-318">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-318">&#182;</a>
              </div>
              <p>inRouteがあることを確認し、実行</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (_.isFunction(<span class="hljs-keyword">this</span>.onRoute)){
      <span class="hljs-keyword">this</span>.onRoute(routeName, routePath, routeArgs);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-319">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-319">&#182;</a>
              </div>
              <p><code>appRoutes</code>の定義に従い、
指定された<code>controller</code>で、該当するメソッドを実行する内部メソッドです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  processAppRoutes: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(controller, appRoutes)</span> {</span>
    <span class="hljs-keyword">if</span> (!appRoutes){ <span class="hljs-keyword">return</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-320">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-320">&#182;</a>
              </div>
              <p>Backboneのルートは逆順</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> routeNames = _.keys(appRoutes).reverse();

    _.each(routeNames, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(route)</span> {</span>
      <span class="hljs-keyword">this</span>._addAppRoute(controller, route, appRoutes[route]);
    }, <span class="hljs-keyword">this</span>);
  },

  _getController: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">return</span> Marionette.getOption(<span class="hljs-keyword">this</span>, <span class="hljs-string">"controller"</span>);
  },

  _addAppRoute: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(controller, route, methodName)</span>{</span>
    <span class="hljs-keyword">var</span> method = controller[methodName];

    <span class="hljs-keyword">if</span> (!method) {
      throwError(<span class="hljs-string">"Method '"</span> + methodName + <span class="hljs-string">"' was not found on the controller"</span>);
    }

    <span class="hljs-keyword">this</span>.route(route, methodName, _.bind(method, controller));
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-321">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-321">&#182;</a>
              </div>
              <h2 id="application">Application</h2>

            </div>
            
        </li>
        
        
        <li id="section-322">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-322">&#182;</a>
              </div>
              <p>いわゆるアプリケーション全体を統括します。
<code>Region</code>オブジェクトを持ち、<code>app.vent</code>として全体用のイベントも管理します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Marionette.Application = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span>{</span>
  <span class="hljs-keyword">this</span>._initRegionManager();
  <span class="hljs-keyword">this</span>._initCallbacks = <span class="hljs-keyword">new</span> Marionette.Callbacks();
  <span class="hljs-keyword">this</span>.vent = <span class="hljs-keyword">new</span> Backbone.Wreqr.EventAggregator();
  <span class="hljs-keyword">this</span>.commands = <span class="hljs-keyword">new</span> Backbone.Wreqr.Commands();
  <span class="hljs-keyword">this</span>.reqres = <span class="hljs-keyword">new</span> Backbone.Wreqr.RequestResponse();
  <span class="hljs-keyword">this</span>.submodules = {};

  _.extend(<span class="hljs-keyword">this</span>, options);

  <span class="hljs-keyword">this</span>.triggerMethod = Marionette.triggerMethod;
};

_.extend(Marionette.Application.prototype, Backbone.Events, {</pre></div></div>
            
        </li>
        
        
        <li id="section-323">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-323">&#182;</a>
              </div>
              <p>Backbone.Wreqr.Commandsのコマンドを実行します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  execute: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">this</span>.commands.execute.apply(<span class="hljs-keyword">this</span>.commands, <span class="hljs-built_in">arguments</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-324">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-324">&#182;</a>
              </div>
              <p>Backbone.Wreqr.RequestResponseの<code>request</code>です。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  request: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.reqres.request.apply(<span class="hljs-keyword">this</span>.reqres, <span class="hljs-built_in">arguments</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-325">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-325">&#182;</a>
              </div>
              <p><code>start</code>メソッドが呼ばれた時に実行される初期化メソッドを追加します。
<code>start</code>メソッドが呼ばれた後で追加されたものは、即実行されます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addInitializer: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(initializer)</span>{</span>
    <span class="hljs-keyword">this</span>._initCallbacks.add(initializer);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-326">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-326">&#182;</a>
              </div>
              <p>アプリケーションを起動します。
追加された全てのリージョンの初期化メソッドを実行します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  start: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span>{</span>
    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"initialize:before"</span>, options);
    <span class="hljs-keyword">this</span>._initCallbacks.run(options, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"initialize:after"</span>, options);

    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"start"</span>, options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-327">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-327">&#182;</a>
              </div>
              <p>アプリケーションにリージョンを追加します。
以下の2パターンの使い方ができます。
addRegions({something: “#someRegion”})
addRegions({something: Region.extend({el: “#someRegion”}) });</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addRegions: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(regions)</span>{</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._regionManager.addRegions(regions);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-328">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-328">&#182;</a>
              </div>
              <p>リージョンを全て閉じますが、削除はしません。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  closeRegions: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">this</span>._regionManager.closeRegions();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-329">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-329">&#182;</a>
              </div>
              <p>リージョン名を指定して、そのリージョンを削除します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  removeRegion: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(region)</span> {</span>
    <span class="hljs-keyword">this</span>._regionManager.removeRegion(region);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-330">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-330">&#182;</a>
              </div>
              <p>リージョン名を指定して、そのリージョンを取得します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getRegion: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(region)</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._regionManager.get(region);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-331">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-331">&#182;</a>
              </div>
              <p>アプリケーションに紐付けるモジュールを作成します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  module: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(moduleNames, moduleDefinition)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-332">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-332">&#182;</a>
              </div>
              <p>既にモジュールクラスが定義されていればそれを使います。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> ModuleClass = Marionette.Module.getClass(moduleDefinition);</pre></div></div>
            
        </li>
        
        
        <li id="section-333">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-333">&#182;</a>
              </div>
              <p>引数の先頭に、アプリケーション自身を入れ込みます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> args = slice.call(<span class="hljs-built_in">arguments</span>);
    args.unshift(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-334">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-334">&#182;</a>
              </div>
              <p>詳しくは、Marionette.Moduleのコードを参照してください。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> ModuleClass.create.apply(ModuleClass, args);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-335">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-335">&#182;</a>
              </div>
              <p>リージョンマネージャーを起動する内部メソッドです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _initRegionManager: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">this</span>._regionManager = <span class="hljs-keyword">new</span> Marionette.RegionManager();

    <span class="hljs-keyword">this</span>.listenTo(<span class="hljs-keyword">this</span>._regionManager, <span class="hljs-string">"region:add"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, region)</span>{</span>
      <span class="hljs-keyword">this</span>[name] = region;
    });

    <span class="hljs-keyword">this</span>.listenTo(<span class="hljs-keyword">this</span>._regionManager, <span class="hljs-string">"region:remove"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, region)</span>{</span>
      <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>[name];
    });
  }
});</pre></div></div>
            
        </li>
        
        
        <li id="section-336">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-336">&#182;</a>
              </div>
              <p>Backboneの<code>extend</code>を継承</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Marionette.Application.extend = Marionette.extend;</pre></div></div>
            
        </li>
        
        
        <li id="section-337">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-337">&#182;</a>
              </div>
              <h2 id="module">Module</h2>

            </div>
            
        </li>
        
        
        <li id="section-338">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-338">&#182;</a>
              </div>
              <p>アプリケーションをカプセル化するための、シンプルなモジュールの実装です。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Marionette.Module = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(moduleName, app, options)</span>{</span>
  <span class="hljs-keyword">this</span>.moduleName = moduleName;
  <span class="hljs-keyword">this</span>.options = _.extend({}, <span class="hljs-keyword">this</span>.options, options);</pre></div></div>
            
        </li>
        
        
        <li id="section-339">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-339">&#182;</a>
              </div>
              <p>インスタンスごとにオーバーライドできるようにします。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.initialize = options.initialize || <span class="hljs-keyword">this</span>.initialize;</pre></div></div>
            
        </li>
        
        
        <li id="section-340">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-340">&#182;</a>
              </div>
              <p>サブモジュールを内部に保持します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.submodules = {};

  <span class="hljs-keyword">this</span>._setupInitializersAndFinalizers();</pre></div></div>
            
        </li>
        
        
        <li id="section-341">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-341">&#182;</a>
              </div>
              <p>モジュール内にアプリケーションへの参照を保持します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.app = app;</pre></div></div>
            
        </li>
        
        
        <li id="section-342">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-342">&#182;</a>
              </div>
              <p>デフォルトでは、親と同時に起動します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.startWithParent = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-343">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-343">&#182;</a>
              </div>
              <p><code>triggerMethod</code>を使います。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.triggerMethod = Marionette.triggerMethod;

  <span class="hljs-keyword">if</span> (_.isFunction(<span class="hljs-keyword">this</span>.initialize)){
    <span class="hljs-keyword">this</span>.initialize(<span class="hljs-keyword">this</span>.options, moduleName, app);
  }
};

Marionette.Module.extend = Marionette.extend;</pre></div></div>
            
        </li>
        
        
        <li id="section-344">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-344">&#182;</a>
              </div>
              <p>モジュールのprototypeをBackbone.Eventsで拡張します。
こうすることでPub/Subオブジェクトとしても使うことができます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>_.extend(Marionette.Module.prototype, Backbone.Events, {</pre></div></div>
            
        </li>
        
        
        <li id="section-345">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-345">&#182;</a>
              </div>
              <p><code>initialize</code>はデフォルトでは空のメソッドです。
モジュールを作る際に実装してください。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  initialize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>},</pre></div></div>
            
        </li>
        
        
        <li id="section-346">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-346">&#182;</a>
              </div>
              <p>モジュールの<code>start</code>メソッドが呼ばれた時に実行されるコールバックを追加します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addInitializer: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span>{</span>
    <span class="hljs-keyword">this</span>._initializerCallbacks.add(callback);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-347">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-347">&#182;</a>
              </div>
              <p>こちらはモジュールの<code>stop</code>メソッドが呼ばれた時に実行されるコールバックを追加します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addFinalizer: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span>{</span>
    <span class="hljs-keyword">this</span>._finalizerCallbacks.add(callback);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-348">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-348">&#182;</a>
              </div>
              <p>モジュールを起動し、<code>addInitializer</code>で追加したコールバックを実行します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  start: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-349">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-349">&#182;</a>
              </div>
              <p>起動するのは1度きり</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._isInitialized){ <span class="hljs-keyword">return</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-350">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-350">&#182;</a>
              </div>
              <p>サブモジュールも起動</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(<span class="hljs-keyword">this</span>.submodules, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(mod)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-351">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-351">&#182;</a>
              </div>
              <p>サブモジュールを親モジュールと同士に起動するかチェック</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (mod.startWithParent){
        mod.start(options);
      }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-352">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-352">&#182;</a>
              </div>
              <p>“start”イベントに紐づくコールバックを実行</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"before:start"</span>, options);

    <span class="hljs-keyword">this</span>._initializerCallbacks.run(options, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>._isInitialized = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">this</span>.triggerMethod(<span class="hljs-string">"start"</span>, options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-353">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-353">&#182;</a>
              </div>
              <p>モジュールを停止し、<code>addFinalizer</code>で追加したコールバックを実行します。
このモジュールのサブモジュールも全て停止されます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  stop: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-354">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-354">&#182;</a>
              </div>
              <p>初期化されてないものは無視</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._isInitialized){ <span class="hljs-keyword">return</span>; }
    <span class="hljs-keyword">this</span>._isInitialized = <span class="hljs-literal">false</span>;

    Marionette.triggerMethod.call(<span class="hljs-keyword">this</span>, <span class="hljs-string">"before:stop"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-355">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-355">&#182;</a>
              </div>
              <p>階層の深いサブモジュールから停止していきます。
親モジュールを停止する前に、必ず停止させます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(<span class="hljs-keyword">this</span>.submodules, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(mod)</span>{</span> mod.stop(); });</pre></div></div>
            
        </li>
        
        
        <li id="section-356">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-356">&#182;</a>
              </div>
              <p>停止処理を実行</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._finalizerCallbacks.run(<span class="hljs-literal">undefined</span>,<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-357">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-357">&#182;</a>
              </div>
              <p>初期化/停止時のコールバックをリセット</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._initializerCallbacks.reset();
    <span class="hljs-keyword">this</span>._finalizerCallbacks.reset();

    Marionette.triggerMethod.call(<span class="hljs-keyword">this</span>, <span class="hljs-string">"stop"</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-358">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-358">&#182;</a>
              </div>
              <p>モジュールを定義します。
引数はすべてモジュールの定義へ渡されます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addDefinition: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(moduleDefinition, customArgs)</span>{</span>
    <span class="hljs-keyword">this</span>._runModuleDefinition(moduleDefinition, customArgs);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-359">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-359">&#182;</a>
              </div>
              <p>正しい引数でモジュールを定義するための内部メソッドです。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _runModuleDefinition: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(definition, customArgs)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-360">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-360">&#182;</a>
              </div>
              <p>定義がないなら返る</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!definition){ <span class="hljs-keyword">return</span>; }</pre></div></div>
            
        </li>
        
        
        <li id="section-361">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-361">&#182;</a>
              </div>
              <p>モジュール定義への引数を整理</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> args = _.flatten([
      <span class="hljs-keyword">this</span>,
      <span class="hljs-keyword">this</span>.app,
      Backbone,
      Marionette,
      Marionette.$, _,
      customArgs
    ]);

    definition.apply(<span class="hljs-keyword">this</span>, args);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-362">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-362">&#182;</a>
              </div>
              <p>初期化/停止のコールバックをリセットします。
これが呼ばれると、既に追加されていたコールバックは削除されます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _setupInitializersAndFinalizers: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    <span class="hljs-keyword">this</span>._initializerCallbacks = <span class="hljs-keyword">new</span> Marionette.Callbacks();
    <span class="hljs-keyword">this</span>._finalizerCallbacks = <span class="hljs-keyword">new</span> Marionette.Callbacks();
  }
});

_.extend(Marionette.Module, {</pre></div></div>
            
        </li>
        
        
        <li id="section-363">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-363">&#182;</a>
              </div>
              <p>アプリケーションへの引数を親オブジェクトとしてモジュールを作成します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  create: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app, moduleNames, moduleDefinition)</span>{</span>
    <span class="hljs-keyword">var</span> module = app;</pre></div></div>
            
        </li>
        
        
        <li id="section-364">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-364">&#182;</a>
              </div>
              <p>引数からモジュール名と定義自体を除きます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> customArgs = slice.call(<span class="hljs-built_in">arguments</span>);
    customArgs.splice(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-365">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-365">&#182;</a>
              </div>
              <p>モジュール名を分割し、サブモジュールの数を取得します。
<code>Doge.Wow.Amaze</code>の場合、3つのモジュールが存在します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    moduleNames = moduleNames.split(<span class="hljs-string">"."</span>);
    <span class="hljs-keyword">var</span> length = moduleNames.length;</pre></div></div>
            
        </li>
        
        
        <li id="section-366">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-366">&#182;</a>
              </div>
              <p>最後のモジュールのために、定義を保持しておきます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> moduleDefinitions = [];
    moduleDefinitions[length-<span class="hljs-number">1</span>] = moduleDefinition;</pre></div></div>
            
        </li>
        
        
        <li id="section-367">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-367">&#182;</a>
              </div>
              <p>モジュール定義をループしていきます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _.each(moduleNames, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(moduleName, i)</span>{</span>
      <span class="hljs-keyword">var</span> parentModule = module;
      module = <span class="hljs-keyword">this</span>._getModule(parentModule, moduleName, app, moduleDefinition);
      <span class="hljs-keyword">this</span>._addModuleDefinition(parentModule, module, moduleDefinitions[i], customArgs);
    }, <span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-368">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-368">&#182;</a>
              </div>
              <p>定義のチェーンの最後のモジュールを返します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> module;
  },

  _getModule: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(parentModule, moduleName, app, def, args)</span>{</span>
    <span class="hljs-keyword">var</span> options = _.extend({}, def);
    <span class="hljs-keyword">var</span> ModuleClass = <span class="hljs-keyword">this</span>.getClass(def);</pre></div></div>
            
        </li>
        
        
        <li id="section-369">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-369">&#182;</a>
              </div>
              <p>定義されていればそのモジュールを取得します。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> module = parentModule[moduleName];

    <span class="hljs-keyword">if</span> (!module){</pre></div></div>
            
        </li>
        
        
        <li id="section-370">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-370">&#182;</a>
              </div>
              <p>定義がない場合は、新たに作成</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      module = <span class="hljs-keyword">new</span> ModuleClass(moduleName, app, options);
      parentModule[moduleName] = module;</pre></div></div>
            
        </li>
        
        
        <li id="section-371">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-371">&#182;</a>
              </div>
              <p>親に保存</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      parentModule.submodules[moduleName] = module;
    }

    <span class="hljs-keyword">return</span> module;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-372">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-372">&#182;</a>
              </div>
              <h2 id="module-classes">Module Classes</h2>
<p>モジュールクラスを使うことでもモジュールは定義できます。
モジュールの<code>extend</code>は他のBackboneやMarionetteのクラスと同じです。
これにより、<code>onStart</code>や<code>onStop</code>といったライフサイクルイベントを使うことができます。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getClass: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(moduleDefinition)</span> {</span>
    <span class="hljs-keyword">var</span> ModuleClass = Marionette.Module;

    <span class="hljs-keyword">if</span> (!moduleDefinition) {
      <span class="hljs-keyword">return</span> ModuleClass;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-373">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-373">&#182;</a>
              </div>
              <p>全てのモジュール定義がクラス内にある場合は、そのまま使います。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (moduleDefinition.prototype <span class="hljs-keyword">instanceof</span> ModuleClass) {
      <span class="hljs-keyword">return</span> moduleDefinition;
    }

    <span class="hljs-keyword">return</span> moduleDefinition.moduleClass || ModuleClass;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-374">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-374">&#182;</a>
              </div>
              <p>モジュール定義を追加し、<code>startWithParent</code>のコールバックを追加します。
モジュール定義は無名関数やモジュールやオプションなど、
重度にオーバーロードされることもあるので、複雑な実装になっています。</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _addModuleDefinition: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(parentModule, module, def, args)</span>{</span>
    <span class="hljs-keyword">var</span> fn = <span class="hljs-keyword">this</span>._getDefine(def);
    <span class="hljs-keyword">var</span> startWithParent = <span class="hljs-keyword">this</span>._getStartWithParent(def, module);

    <span class="hljs-keyword">if</span> (fn){
      module.addDefinition(fn, args);
    }

    <span class="hljs-keyword">this</span>._addStartWithParent(parentModule, module, startWithParent);
  },

  _getStartWithParent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(def, module)</span> {</span>
    <span class="hljs-keyword">var</span> swp;

    <span class="hljs-keyword">if</span> (_.isFunction(def) &amp;&amp; (def.prototype <span class="hljs-keyword">instanceof</span> Marionette.Module)) {
      swp = module.constructor.prototype.startWithParent;
      <span class="hljs-keyword">return</span> _.isUndefined(swp) ? <span class="hljs-literal">true</span> : swp;
    }

    <span class="hljs-keyword">if</span> (_.isObject(def)){
      swp = def.startWithParent;
      <span class="hljs-keyword">return</span> _.isUndefined(swp) ? <span class="hljs-literal">true</span> : swp;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },

  _getDefine: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(def)</span> {</span>
    <span class="hljs-keyword">if</span> (_.isFunction(def) &amp;&amp; !(def.prototype <span class="hljs-keyword">instanceof</span> Marionette.Module)) {
      <span class="hljs-keyword">return</span> def;
    }

    <span class="hljs-keyword">if</span> (_.isObject(def)){
      <span class="hljs-keyword">return</span> def.define;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  },

  _addStartWithParent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(parentModule, module, startWithParent)</span> {</span>
    module.startWithParent = module.startWithParent &amp;&amp; startWithParent;

    <span class="hljs-keyword">if</span> (!module.startWithParent || !!module.startWithParentIsConfigured){
      <span class="hljs-keyword">return</span>;
    }

    module.startWithParentIsConfigured = <span class="hljs-literal">true</span>;

    parentModule.addInitializer(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span>{</span>
      <span class="hljs-keyword">if</span> (module.startWithParent){
        module.start(options);
      }
    });
  }
});


  <span class="hljs-keyword">return</span> Marionette;
})(<span class="hljs-keyword">this</span>, Backbone, _);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
